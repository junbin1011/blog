<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="一花一世界，一码一浮生">
<meta property="og:type" content="website">
<meta property="og:title" content="JunBin">
<meta property="og:url" content="https://junbin1011.github.io/index.html">
<meta property="og:site_name" content="JunBin">
<meta property="og:description" content="一花一世界，一码一浮生">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JunBin">
<meta name="twitter:description" content="一花一世界，一码一浮生">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://junbin1011.github.io/">





  <title> JunBin </title>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b3ffb4912eee79c795100275f268095c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JunBin</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">一花一世界，一码一浮生</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2021/07/13/移动应用遗留系统重构（17）-流水线设计篇/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/13/移动应用遗留系统重构（17）-流水线设计篇/" itemprop="url">
                  移动应用遗留系统重构（17）-流水线设计篇
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-13T07:20:22+08:00">
                2021-07-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/13/移动应用遗留系统重构（17）-流水线设计篇/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/13/移动应用遗留系统重构（17）-流水线设计篇/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇<a href="https://juejin.cn/post/6981044230038749220" target="_blank" rel="noopener">移动应用遗留系统重构（16）- Gradle依赖管理篇</a>我们提到随着重构工作的持续，各个模块已经补充了足量的自动化测试，但CloudDisk团队目前的CI只提供打包的功能，供测试团队进行验证。分仓以后也没有对独立模块仓库建立流水线，测试团队还是只能在最后做集成的验收。我们将重新对CloudDisk进行流水线的设计，必须满足质量门禁检查及根据模块、集成，制定对应的策略。</p>
<h1 id="流水线"><a href="#流水线" class="headerlink" title="流水线"></a>流水线</h1><p><strong>流水线是从代码到产品的完整生命周期的可视化呈现，快速反馈产品的可交付状态，引导团队快速响应。</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A(代码提交)--&gt;B(质量门禁)</span><br><span class="line">B--&gt;C(构建)</span><br><span class="line">C--&gt;D(自动化测试)</span><br><span class="line">D--&gt;E(发布)</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>其中质量门禁通常包括代码规范检查、安全漏洞检查等；自动化测通过包过小型的单元测试、中型的接口测试等</p>
</blockquote>
<h2 id="质量门禁"><a href="#质量门禁" class="headerlink" title="质量门禁"></a>质量门禁</h2><p>统一使用<a href="https://sonarcloud.io/" target="_blank" rel="noopener">sonar</a>进行质量域管理,集成Lint、CheckStyle、Findbugs、Jacoco。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5925d66e0bce436e96940affee5b9ce8~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>自动化测试包含单元测试、接口测试、验收UI测试、架构守护测试，并通过jacoco统计覆盖率上传至sonar。</p>
<h2 id="组件流水线"><a href="#组件流水线" class="headerlink" title="组件流水线"></a>组件流水线</h2><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ac5d748bb49433fbb9c2dd1fdf07ba9~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<ol>
<li>业务平台成员提交代码后自动触发流水线检查</li>
<li>Pre-review验证包含质量门禁检查、编译及自动化测试</li>
<li>团队内架构师进行review后代码合入</li>
<li>发布最新的组件版本到maven制品库</li>
</ol>
<h2 id="集成流水线"><a href="#集成流水线" class="headerlink" title="集成流水线"></a>集成流水线</h2><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f834022d6694caabbe9cdee8ec0c4a9~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<ol>
<li>产品团队根据版本规划，提交组件集成版本清单</li>
<li>自动触发Pre-review验证包含质量门禁检查、编译及自动化测试</li>
<li>团队内架构师进行review，产品经理进行确认后代码合入</li>
<li>发布最新的应用版本到制品库</li>
<li>团队确认后选择渠道(内测、灰度、应用市场、全量)进行发布</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本篇我们分享了CloudDisk团队的新流水线设计，增加了质量门禁，提高代码入库质量。同时也为组件设计了流水线，方便快速反馈对组件进行测试验收。</p>
<p>下一篇移动应用遗留系统重构（18）- 总结篇是本系列的最后一篇，我们将分享在实际项目中除了技术外的一些踩坑心得，并对整个系列进行总结回顾。</p>
<h1 id="CloudDisk示例代码"><a href="#CloudDisk示例代码" class="headerlink" title="CloudDisk示例代码"></a>CloudDisk示例代码</h1><p><a href="https://github.com/junbin1011/CloudDisk" target="_blank" rel="noopener">CloudDisk</a></p>
<h1 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h1><p><a href="https://juejin.cn/post/6943470229905211422" target="_blank" rel="noopener">移动应用遗留系统重构（1）- 开篇</a></p>
<p><a href="https://juejin.cn/post/6945313969556946980" target="_blank" rel="noopener">移动应用遗留系统重构（2）-架构篇</a></p>
<p><a href="https://juejin.cn/post/6947855094272491556" target="_blank" rel="noopener">移动应用遗留系统重构（3）-示例篇</a></p>
<p><a href="https://juejin.cn/post/6950077521790500894" target="_blank" rel="noopener">移动应用遗留系统重构（4）-分析篇</a></p>
<p><a href="https://juejin.cn/post/6952298178095874055" target="_blank" rel="noopener">移动应用遗留系统重构（5）- 重构方法篇</a></p>
<p><a href="https://juejin.cn/post/6954635678982340622" target="_blank" rel="noopener">移动应用遗留系统重构（6）- 测试篇</a></p>
<p><a href="https://juejin.cn/post/6959504791642832909" target="_blank" rel="noopener">移动应用遗留系统重构（7）- 解耦重构演示篇(一)+视频演示</a></p>
<p><a href="https://juejin.cn/post/6963214120178941983" target="_blank" rel="noopener">移动应用遗留系统重构（8）- 依赖注入篇</a></p>
<p><a href="https://juejin.cn/post/6966166367821103117" target="_blank" rel="noopener">移动应用遗留系统重构（9）- 路由篇</a></p>
<p><a href="https://juejin.cn/post/6970870458660945934" target="_blank" rel="noopener">移动应用遗留系统重构（10）- 解耦重构演示篇（二）</a></p>
<p><a href="https://juejin.cn/post/6973836199655899149" target="_blank" rel="noopener">移动应用遗留系统重构（11）- 制品管理篇</a></p>
<p><a href="https://juejin.cn/post/6974634615537401886" target="_blank" rel="noopener">移动应用遗留系统重构（12）- 编译调试篇</a></p>
<p><a href="https://juejin.cn/post/6975877150314332168" target="_blank" rel="noopener">移动应用遗留系统重构（13）- 编译调试篇</a></p>
<p><a href="https://juejin.cn/post/6975877150314332168" target="_blank" rel="noopener">移动应用遗留系统重构（13）- 编译调试篇</a></p>
<p><a href="https://juejin.cn/post/6977702335879315493" target="_blank" rel="noopener">移动应用遗留系统重构（14）- Kotlin+MVVM重构示例篇</a></p>
<p><a href="https://juejin.cn/post/6979198588630859806" target="_blank" rel="noopener">移动应用遗留系统重构（15）- 数据库重构示例篇</a></p>
<p><a href="https://juejin.cn/post/6981044230038749220" target="_blank" rel="noopener">移动应用遗留系统重构（16）- Gradle依赖管理篇</a></p>
<h1 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h1><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c436727f5f0f4e4db666e3e63fb8363a~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<h1 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h1><ul>
<li>作者：黄俊彬 </li>
<li><a href="https://junbin.tech/" target="_blank" rel="noopener">博客：junbin.tech</a></li>
<li><a href="https://github.com/junbin1011" target="_blank" rel="noopener">GitHub: junbin1011 </a></li>
<li><a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" rel="noopener">知乎: @JunBin</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2021/07/05/每天写代码，如何瘦身34斤？/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/05/每天写代码，如何瘦身34斤？/" itemprop="url">
                  每天写代码，如何瘦身34斤？
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-05T19:35:12+08:00">
                2021-07-05
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/05/每天写代码，如何瘦身34斤？/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/05/每天写代码，如何瘦身34斤？/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="成果"><a href="#成果" class="headerlink" title="成果"></a>成果</h1><p><strong>先上成果图：</strong></p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB7c778d46da7b0bac456cfa03a2d3d02e?method=download&shareKey=1ac17cec2c26bd35d7cf398b75d3206b" height="600"></p>
<p><strong>减肥前后BMI：</strong><br><img src="https://note.youdao.com/yws/api/personal/file/WEB167d0ea5a3d1767c2e766db4d5d91014?method=download&amp;shareKey=852922d31864c415dfb3b3eb6fe4c70b" alt=""></p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB4ec7e624e1463878e46ea955fcfc76e5?method=download&amp;shareKey=8d9e44dcb9dbca122733e15bb7a08c44" alt=""></p>
<h1 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h1><p>时间来到2021年2月，刚好回老家过了个年。所谓“每逢佳节胖三斤”，之前长期的体重维持在166左右，过年那会足足胖了10斤,涨到了176。</p>
<p>其实肥胖的体质，会给身体带来很大的负担，并且很容易血压、血脂、胆固醇、尿酸等超标。30岁的身体能活出50岁的指标😂。其实之前也陆陆续续尝试过减肥，但总是像过上车一样反反复复。于是我就在想一个问题，这个事真这么难吗？是没时间，还是坚持不住？是方法不对，还是抵挡不住诱惑？</p>
<p>其实现在回过头来想，这个原因也很简单。一句话来总结就是，“<strong>道理我都懂，但臣妾做不到啊… …</strong>”</p>
<p><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fgss0.baidu.com%2F94o3dSag_xI4khGko9WTAnF6hhy%2Fzhidao%2Fwh%253D450%252C600%2Fsign%3De804ef49790e0cf3a0a246ff3f76de29%2Ff636afc379310a55cb4f9cafbc4543a982261005.jpg&amp;refer=http%3A%2F%2Fgss0.baidu.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=jpeg?sec=1627998017&amp;t=8d1e6a0d03ee639d57ed7f95e653373f" alt=""></p>
<p>其实好多事情都是一样，例如学习、读书、写作等等。“惰性”是我们需要首先去克服的第一道难关。所以我也希望借减肥这个事来不断警示自己，“<strong>能坚持下去的自律，都会成为蜕变的契机</strong>”。</p>
<h1 id="战略与战术"><a href="#战略与战术" class="headerlink" title="战略与战术"></a>战略与战术</h1><h2 id="1-先给自己定个小目标，比如…"><a href="#1-先给自己定个小目标，比如…" class="headerlink" title="1. 先给自己定个小目标，比如…"></a>1. 先给自己定个小目标，比如…</h2><p><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic1.zhimg.com%2F50%2Fv2-ab30bf12cee69b9f28ff0cc8489c91b2_hd.jpg&amp;refer=http%3A%2F%2Fpic1.zhimg.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=jpeg?sec=1627999386&amp;t=4430d929efbd43f113a020709f8c4077" alt=""></p>
<p>其实当我决定坚持减肥的时候，就开始给自己设定了一个目标，40斤。但是不一样的是，我并没有给这个目标设定一个期限。没有设置时间的原因是觉得这个事不是一个阶段，应该是一个持续的过程。如果只为了短期的减，那就又走回之前的老路了。但是阶段性的小目标可以有，比如每5斤都是一个时间节点，能够持续不断的给自己激励。</p>
<p><strong>目标很重要，有了目标才有方向！</strong></p>
<h2 id="2-管住嘴，迈开腿"><a href="#2-管住嘴，迈开腿" class="headerlink" title="2. 管住嘴，迈开腿"></a>2. 管住嘴，迈开腿</h2><p><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fr.sinaimg.cn%2Flarge%2Farticle%2F2e157029fa88a12ae16710ff3e8601b4&refer=http%3A%2F%2Fr.sinaimg.cn&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1627999756&t=a2c5bd3fda535fd24e91c8b6c0c01a76" width="400"></p>
<p>有了目标以后，接下来就是执行的阶段。道理还是那么简单，“能量守恒定律”。调整饮食结构，低脂低碳水，高蛋白，加强热量的消耗，就是这么简单。</p>
<p>对我来说，晚上基本都是“代餐”，即省了吃一餐饭的时间用于锻炼，又能满足身体的能量诉求。同时坚持每天30分钟以上的有氧消耗。对于最开始的10斤，在1-2个星期就能降下来了。慢慢的也会变成新的生活习惯和方式，不再是一件觉得“痛苦”的事情。</p>
<h2 id="3-度量反馈，持续改进"><a href="#3-度量反馈，持续改进" class="headerlink" title="3. 度量反馈，持续改进"></a>3. 度量反馈，持续改进</h2><p><img src="https://upload-images.jianshu.io/upload_images/5125122-a6e9118030ef0228?imageMogr2/auto-orient/strip|imageView2/2/w/1080/format/webp" height="600"></p>
<p>每天进行体重及体脂的跟踪,适当调整饮食的结构及训练的方案。度量是每天提醒自己的警钟，当你抵挡不住诱惑的时候，看一看，也许你就会有不一样的选择。</p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>这并不意味着结束，而只是一个开始。想想最大的挑战不是这4个月减34斤的体重，而是1个月后、1年后，能否还能依旧保持。最后引用《你的自律，给你自由》的一段话来勉励自己。</p>
<blockquote>
<p>人生的自律是对自己的思想、时间、精力、情绪、资源等多方面进行有效管理，自律一旦成为深入骨髓的习惯，将会终生受益；在自律的过程中，我们也会更深刻地认识自己，克服浮躁、远离焦虑、走出迷茫，释放出自己更大的潜力；自律能够带给你发自内心的平静和享受。因为你知道，自己在一天天地改变，能坚持下去的自律，都会成为蜕变的契机。高级高效的自律会让你拥有时间、金钱甚至思想的自由，会给你的人生带来更多的选择空间</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2021/07/04/移动应用遗留系统重构（16）-Gradle依赖管理篇/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/07/04/移动应用遗留系统重构（16）-Gradle依赖管理篇/" itemprop="url">
                  移动应用遗留系统重构（16）- Gradle依赖管理篇
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-04T20:19:55+08:00">
                2021-07-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/07/04/移动应用遗留系统重构（16）-Gradle依赖管理篇/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/07/04/移动应用遗留系统重构（16）-Gradle依赖管理篇/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇<a href="https://juejin.cn/post/6979198588630859806" target="_blank" rel="noopener">移动应用遗留系统重构（15）- 数据库重构示例篇</a>我们提到CloudDisk团队已经拆分成了多仓库开发，但各个模块各自维护了第三方库。除了版本不统一、也导致打包构建时会带入多个版本的三方库。</p>
<p>由于目前各业务模块已经分仓开发，我们无法ext.的声明，统一版本号及定义库别名。我们只能以Gradle插件的形式发布到Maven库中，这样所有其他模块就可以直接apply使用。</p>
<h1 id="CloudDisk-Gradle-插件改造"><a href="#CloudDisk-Gradle-插件改造" class="headerlink" title="CloudDisk Gradle 插件改造"></a>CloudDisk Gradle 插件改造</h1><h2 id="Gradle-插件"><a href="#Gradle-插件" class="headerlink" title="Gradle 插件"></a>Gradle 插件</h2><ol>
<li>创建buildSrc模块</li>
<li>创建BasePlugin类及LibPluginExtension</li>
<li>创建resource/META-INF/gradle-plugin/com.cloud.disk.plugin.properties,声明class<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation-class=com.cloud.disk.plugin.BasePlugin</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>4.发布插件，在使用的工程apply<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &apos;com.cloud.disk.plugin&apos;</span><br></pre></td></tr></table></figure></p>
<p>BasePlugin类如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class BasePlugin implements Plugin&lt;Project&gt; &#123;</span><br><span class="line"></span><br><span class="line">    public static Project mProject</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    void apply(Project project) &#123;</span><br><span class="line">        mProject=project</span><br><span class="line">        project.extensions.create(&quot;Lib&quot;, LibPluginExtension.class)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>LibPluginExtension类如下,部分代码省略：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public class LibPluginExtension &#123;</span><br><span class="line">    String roomVersion = &apos;2.2.6&apos;</span><br><span class="line">    String lifeCycleVersion = &apos;2.3.0&apos;</span><br><span class="line">    String hiltVersion = &apos;2.31.2-alpha&apos;</span><br><span class="line">    //... ...</span><br><span class="line"></span><br><span class="line">    void test() &#123;</span><br><span class="line">        BasePlugin.mProject.dependencies &#123;</span><br><span class="line">            testImplementation &quot;junit:junit:$junitVersion&quot;</span><br><span class="line">            testImplementation &quot;org.mockito:mockito-inline:$mockitoVersion&quot;</span><br><span class="line">            testImplementation &quot;android.arch.core:core-testing:1.1.1&quot;</span><br><span class="line">            testImplementation &quot;com.google.truth:truth:1.0.1&quot;</span><br><span class="line">            testImplementation &apos;com.tngtech.archunit:archunit-junit4:0.15.0&apos;</span><br><span class="line">            testImplementation &quot;org.robolectric:robolectric:$robolectricVersion&quot;</span><br><span class="line">            testImplementation &apos;androidx.test:core:1.3.0&apos;</span><br><span class="line">            testImplementation &apos;androidx.test.ext:junit:1.1.2&apos;</span><br><span class="line">            testImplementation &quot;androidx.test.espresso:espresso-core:$espressoVersion&quot;</span><br><span class="line">            testImplementation &quot;androidx.test.espresso:espresso-intents:$espressoVersion&quot;</span><br><span class="line">            debugImplementation &quot;androidx.fragment:fragment-testing:1.3.1&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void room() &#123;</span><br><span class="line">        BasePlugin.mProject.dependencies &#123;</span><br><span class="line">            implementation &quot;androidx.room:room-runtime:$roomVersion&quot;</span><br><span class="line">            implementation &quot;androidx.room:room-ktx:$roomVersion&quot;</span><br><span class="line">            kapt &quot;androidx.room:room-compiler:$roomVersion&quot;</span><br><span class="line">            testImplementation &quot;androidx.room:room-testing:$roomVersion&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void coroutines() &#123;</span><br><span class="line">        BasePlugin.mProject.dependencies &#123;</span><br><span class="line">            implementation &quot;org.jetbrains.kotlinx:kotlinx-coroutines-core:$coroutinesVersion&quot;</span><br><span class="line">            implementation &quot;org.jetbrains.kotlinx:kotlinx-coroutines-android:$coroutinesVersion&quot;</span><br><span class="line">            testImplementation &quot;org.jetbrains.kotlinx:kotlinx-coroutines-test:1.3.3&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     </span><br><span class="line">    // ... ...</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="CloudDisk-改造"><a href="#CloudDisk-改造" class="headerlink" title="CloudDisk 改造"></a>CloudDisk 改造</h2><ol>
<li><p>dynamicBundle模块修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation &apos;com.cloud.disk:api:1.0.0&apos;</span><br><span class="line">    implementation &apos;com.cloud.disk:library:1.0.0&apos;</span><br><span class="line">    implementation &apos;com.cloud.disk:platform:1.0.0&apos;</span><br><span class="line"></span><br><span class="line">    project.Lib.kotlin()</span><br><span class="line">    project.Lib.supportV4()</span><br><span class="line">    project.Lib.appCompact()</span><br><span class="line">    project.Lib.material()</span><br><span class="line">    project.Lib.router()</span><br><span class="line">    project.Lib.mvvm()</span><br><span class="line">    project.Lib.ktx()</span><br><span class="line">    project.Lib.coroutines()</span><br><span class="line">    project.Lib.room()</span><br><span class="line">    project.Lib.hilt()</span><br><span class="line">    project.Lib.test()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>dynamicDebug模块修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation &apos;com.cloud.disk:api:1.0.0&apos;</span><br><span class="line">    implementation project(&apos;:dynamicBundle&apos;)</span><br><span class="line"></span><br><span class="line">    project.Lib.hilt()</span><br><span class="line">    project.Lib.test()</span><br><span class="line">    project.Lib.appCompact()</span><br><span class="line">    project.Lib.material()</span><br><span class="line">    project.Lib.constraintlayout()</span><br><span class="line">    project.Lib.kotlin()</span><br><span class="line">    project.Lib.ktx()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>完整修改见<a href="https://github.com/junbin1011/CloudDisk/commit/8e1b7a8c228ecad2b6a1b14deba824cfe9cd80e4" target="_blank" rel="noopener">Github</a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本篇主要分享了 CloudDisk Gradle 插件改造，统一的三方库的版本管理及简化依赖调用，有效的解决了三方库版本不统一问题。</p>
<p>随着重构工作的持续，各个模块已经补充了足量的自动化测试，但CloudDisk团队目前的CI只提供打包的功能，供测试团队进行验证。分仓以后也没有对独立模块仓库建立流水线，测试团队还是只能在最后做集成的验收。</p>
<p>下一篇，移动应用遗留系统重构（17）- 流水线设计篇。我们将重新对CloudDisk进行流水线的设计，必须满足质量门禁检查及根据模块、集成，制定对应的策略。</p>
<h1 id="CloudDisk示例代码"><a href="#CloudDisk示例代码" class="headerlink" title="CloudDisk示例代码"></a>CloudDisk示例代码</h1><p><a href="https://github.com/junbin1011/CloudDisk" target="_blank" rel="noopener">CloudDisk</a></p>
<h1 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h1><p><a href="https://juejin.cn/post/6943470229905211422" target="_blank" rel="noopener">移动应用遗留系统重构（1）- 开篇</a></p>
<p><a href="https://juejin.cn/post/6945313969556946980" target="_blank" rel="noopener">移动应用遗留系统重构（2）-架构篇</a></p>
<p><a href="https://juejin.cn/post/6947855094272491556" target="_blank" rel="noopener">移动应用遗留系统重构（3）-示例篇</a></p>
<p><a href="https://juejin.cn/post/6950077521790500894" target="_blank" rel="noopener">移动应用遗留系统重构（4）-分析篇</a></p>
<p><a href="https://juejin.cn/post/6952298178095874055" target="_blank" rel="noopener">移动应用遗留系统重构（5）- 重构方法篇</a></p>
<p><a href="https://juejin.cn/post/6954635678982340622" target="_blank" rel="noopener">移动应用遗留系统重构（6）- 测试篇</a></p>
<p><a href="https://juejin.cn/post/6959504791642832909" target="_blank" rel="noopener">移动应用遗留系统重构（7）- 解耦重构演示篇(一)+视频演示</a></p>
<p><a href="https://juejin.cn/post/6963214120178941983" target="_blank" rel="noopener">移动应用遗留系统重构（8）- 依赖注入篇</a></p>
<p><a href="https://juejin.cn/post/6966166367821103117" target="_blank" rel="noopener">移动应用遗留系统重构（9）- 路由篇</a></p>
<p><a href="https://juejin.cn/post/6970870458660945934" target="_blank" rel="noopener">移动应用遗留系统重构（10）- 解耦重构演示篇（二）</a></p>
<p><a href="https://juejin.cn/post/6973836199655899149" target="_blank" rel="noopener">移动应用遗留系统重构（11）- 制品管理篇</a></p>
<p><a href="https://juejin.cn/post/6974634615537401886" target="_blank" rel="noopener">移动应用遗留系统重构（12）- 编译调试篇</a></p>
<p><a href="https://juejin.cn/post/6975877150314332168" target="_blank" rel="noopener">移动应用遗留系统重构（13）- 编译调试篇</a></p>
<p><a href="https://juejin.cn/post/6975877150314332168" target="_blank" rel="noopener">移动应用遗留系统重构（13）- 编译调试篇</a></p>
<p><a href="https://juejin.cn/post/6977702335879315493" target="_blank" rel="noopener">移动应用遗留系统重构（14）- Kotlin+MVVM重构示例篇</a></p>
<p><a href="https://juejin.cn/post/6979198588630859806" target="_blank" rel="noopener">移动应用遗留系统重构（15）- 数据库重构示例篇</a></p>
<h1 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h1><p><img src="https://note.youdao.com/yws/api/personal/file/WEBf483992c4f5299577eeb0c039992c8d6?method=download&amp;shareKey=fd4babce2b0d344869bb1b2f7042417d" alt=""></p>
<h1 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h1><ul>
<li>作者：黄俊彬 </li>
<li><a href="https://junbin.tech/" target="_blank" rel="noopener">博客：junbin.tech</a></li>
<li><a href="https://github.com/junbin1011" target="_blank" rel="noopener">GitHub: junbin1011 </a></li>
<li><a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" rel="noopener">知乎: @JunBin</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2021/06/29/移动应用遗留系统重构（15）-数据库重构示例篇/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/06/29/移动应用遗留系统重构（15）-数据库重构示例篇/" itemprop="url">
                  移动应用遗留系统重构（15）- 数据库重构示例篇
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-29T20:43:49+08:00">
                2021-06-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/06/29/移动应用遗留系统重构（15）-数据库重构示例篇/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/06/29/移动应用遗留系统重构（15）-数据库重构示例篇/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇<a href="https://juejin.cn/post/6977702335879315493" target="_blank" rel="noopener">移动应用遗留系统重构（14）- Kotlin+MVVM重构示例篇</a>我们介绍了动态模块团队将动态件主页切换至Kotlin代码、重构为MVVM架构，并且补充了自动化测试。经过重构后，团队的开发效率和版本质量有了明显的提升。但本地数据库的管理依旧还是大量的sql 语句拼写，非常不利于扩展及维护，编写自动化测试也非常麻烦。</p>
<p>Google官方的建议是<a href="https://developer.android.com/training/data-storage/room#db-migration-testing" target="_blank" rel="noopener">我们强烈建议您使用 Room而不是 SQLite</a>。框架带来的好处是节省编写大量的模版代码，易于维护，同时面向接口，便于扩展。关于性能方面，有的同学可能认为，使用原生的SQL语句可以将性能优化到极致，但往往忽略了维护大量的SQL拼写语句也带来了非常大的成本，况且框架也支持自定义SQL语句。</p>
<p>接下来给大家分享，动态模块的本地缓存如何从Sqlite安全、渐进式重构至Room。</p>
<h1 id="重构"><a href="#重构" class="headerlink" title="重构"></a>重构</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">A(1.梳理业务逻辑)--&gt;B(2.分析原有的代码设计)</span><br><span class="line">B--&gt;C(3.补充守护测试)</span><br><span class="line">C--&gt;D(4.简单设计)</span><br><span class="line">D--&gt;E(5.小步安全重构)</span><br><span class="line">E--&gt;F(6.集成验收测试)</span><br></pre></td></tr></table></figure>
<h2 id="1-梳理业务逻辑"><a href="#1-梳理业务逻辑" class="headerlink" title="1.梳理业务逻辑"></a>1.梳理业务逻辑</h2><p>原有的缓存逻辑比较简单，主要提供2个功能。</p>
<ul>
<li>查询缓存的动态数据</li>
<li>保存缓存的动态数据（保存上一次加载的所有数据）</li>
</ul>
<h2 id="2-分析原有的代码设计"><a href="#2-分析原有的代码设计" class="headerlink" title="2.分析原有的代码设计"></a>2.分析原有的代码设计</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">class LocalDataSource @Inject constructor(</span><br><span class="line">        @ApplicationContext private var mContext: Context) : DataSource &#123;</span><br><span class="line"></span><br><span class="line">    //判断游标是否为空</span><br><span class="line">    override fun getDynamicListFromCache(): List&lt;Dynamic&gt; &#123;</span><br><span class="line">        val dynamicList: MutableList&lt;Dynamic&gt; = ArrayList()</span><br><span class="line">        val dataBaseHelper = DataBaseHelper(mContext)</span><br><span class="line">        val c = dataBaseHelper.writableDatabase.query(DataBaseHelper.dynamic_info, null, null, null, null, null, null)</span><br><span class="line">        if (c.moveToFirst()) &#123; //判断游标是否为空</span><br><span class="line">            for (i in 0 until c.count) &#123;</span><br><span class="line">                c.move(i) //移动到指定记录</span><br><span class="line">                val id = c.getInt(c.getColumnIndex(DataBaseHelper.id))</span><br><span class="line">                val content = c.getString(c.getColumnIndex(DataBaseHelper.content))</span><br><span class="line">                val date = c.getLong(c.getColumnIndex(DataBaseHelper.date))</span><br><span class="line">                dynamicList.add(Dynamic(id, content, date))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dynamicList</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override fun saveDynamicToCache(dynamicList: List&lt;Dynamic&gt;?) &#123;</span><br><span class="line">        val dataBaseHelper = DataBaseHelper(mContext)</span><br><span class="line">        dynamicList?.let &#123;</span><br><span class="line">            dataBaseHelper.writableDatabase.delete(DataBaseHelper.dynamic_info, null, null)</span><br><span class="line">            for ((id, content, date) in dynamicList) &#123;</span><br><span class="line">                val cv = ContentValues()</span><br><span class="line">                cv.put(DataBaseHelper.id, id)</span><br><span class="line">                cv.put(DataBaseHelper.content, content)</span><br><span class="line">                cv.put(DataBaseHelper.date, date)</span><br><span class="line">                dataBaseHelper.writableDatabase.insert(DataBaseHelper.dynamic_info, null, cv)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要存在问题：</p>
<ul>
<li>较多模版代码，不利于维护扩展</li>
<li>没有采用事务管理，极端大数据情况下，可能有异常</li>
<li>没有任何的守护测试</li>
</ul>
<h2 id="3-补充守护测试"><a href="#3-补充守护测试" class="headerlink" title="3.补充守护测试"></a>3.补充守护测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(AndroidJUnit4::class)</span><br><span class="line">@MediumTest</span><br><span class="line">class LocalDataSourceTest &#123;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    fun `should get dynamic is empty when database has not data`() &#123;</span><br><span class="line">        //given</span><br><span class="line">        val localDataSource = LocalDataSource(ApplicationProvider.getApplicationContext())</span><br><span class="line">        //when</span><br><span class="line">        val dynamicListFromCache = localDataSource.getDynamicListFromCache()</span><br><span class="line">        //then</span><br><span class="line">        assertThat(dynamicListFromCache).isEmpty()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    fun `should get dynamic success when database has data`() &#123;</span><br><span class="line">        //given</span><br><span class="line">        val localDataSource = LocalDataSource(ApplicationProvider.getApplicationContext())</span><br><span class="line">        localDataSource.saveDynamicToCache(getMockData())</span><br><span class="line">        //when</span><br><span class="line">        val dynamicListFromCache = localDataSource.getDynamicListFromCache()</span><br><span class="line">        //then</span><br><span class="line">        val dynamicOne = dynamicListFromCache[0]</span><br><span class="line">        assertThat(dynamicOne.id).isEqualTo(1)</span><br><span class="line">        assertThat(dynamicOne.content).isEqualTo(&quot;今天天气真不错！&quot;)</span><br><span class="line">        assertThat(dynamicOne.date).isEqualTo(1615963675000L)</span><br><span class="line">        val dynamicTwo = dynamicListFromCache[1]</span><br><span class="line">        assertThat(dynamicTwo.id).isEqualTo(2)</span><br><span class="line">        assertThat(dynamicTwo.content).isEqualTo(&quot;这个连续剧值得追！&quot;)</span><br><span class="line">        assertThat(dynamicTwo.date).isEqualTo(1615963688000L)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private fun getMockData(): ArrayList&lt;Dynamic&gt; &#123;</span><br><span class="line">        val dynamicList = ArrayList&lt;Dynamic&gt;()</span><br><span class="line">        dynamicList.add(Dynamic(1, &quot;今天天气真不错！&quot;, 1615963675000L))</span><br><span class="line">        dynamicList.add(Dynamic(2, &quot;这个连续剧值得追！&quot;, 1615963688000L))</span><br><span class="line">        return dynamicList</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-简单设计"><a href="#4-简单设计" class="headerlink" title="4.简单设计"></a>4.简单设计</h2><p>分步进行重构，小步验证。</p>
<ol>
<li>将SQLiteOpenHelper管理数据库替换成Room的管理，但还是维持原有的SQL操作方式</li>
<li>将原有的SQL操作方式调整为ROOM的Dao形式</li>
<li>使用Coroutine管理数据库的异步操作</li>
<li>调整已有的测试用例</li>
</ol>
<h2 id="5-小步安全重构"><a href="#5-小步安全重构" class="headerlink" title="5.小步安全重构"></a>5.小步安全重构</h2><h3 id="将SQLiteOpenHelper管理数据库替换成Room的管理，但还是维持原有的SQL操作方式"><a href="#将SQLiteOpenHelper管理数据库替换成Room的管理，但还是维持原有的SQL操作方式" class="headerlink" title="将SQLiteOpenHelper管理数据库替换成Room的管理，但还是维持原有的SQL操作方式"></a>将SQLiteOpenHelper管理数据库替换成Room的管理，但还是维持原有的SQL操作方式</h3><ol>
<li>bean改造，注意字段与表名需要与原来一致</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Entity(tableName=&quot;dynamic_info&quot;)</span><br><span class="line">data class Dynamic(@PrimaryKey @ColumnInfo(name = &quot;id&quot;) val id: Int,</span><br><span class="line">                   @ColumnInfo(name = &quot;content&quot;) val content: String,</span><br><span class="line">                   @ColumnInfo(name = &quot;date&quot;) val date: Long) &#123;</span><br><span class="line">    @Ignore</span><br><span class="line">    val formatDate = DateUtil.getDateToString(date)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>使用SupportSQLiteOpenHelper进行管理，继续以writableDatabase进行管理</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">class LocalDataSource @Inject constructor(</span><br><span class="line">        @ApplicationContext private var mContext: Context) : DataSource &#123;</span><br><span class="line"></span><br><span class="line">    val db = Room.databaseBuilder(</span><br><span class="line">            mContext,</span><br><span class="line">            AppDatabase::class.java, &quot;dynamic.db&quot;</span><br><span class="line">    ).build()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //判断游标是否为空</span><br><span class="line">    override fun getDynamicListFromCache(): List&lt;Dynamic&gt; &#123;</span><br><span class="line">        val dynamicList: MutableList&lt;Dynamic&gt; = ArrayList()</span><br><span class="line">        val dataBaseHelper = db.openHelper</span><br><span class="line">        val c = dataBaseHelper.writableDatabase.query(&quot;&quot;)</span><br><span class="line">        if (c.moveToFirst()) &#123; //判断游标是否为空</span><br><span class="line">            for (i in 0 until c.count) &#123;</span><br><span class="line">                c.move(i) //移动到指定记录</span><br><span class="line">                val id = c.getInt(c.getColumnIndex(DataBaseHelper.id))</span><br><span class="line">                val content = c.getString(c.getColumnIndex(DataBaseHelper.content))</span><br><span class="line">                val date = c.getLong(c.getColumnIndex(DataBaseHelper.date))</span><br><span class="line">                dynamicList.add(Dynamic(id, content, date))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dynamicList</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override fun saveDynamicToCache(dynamicList: List&lt;Dynamic&gt;?) &#123;</span><br><span class="line">        val dataBaseHelper = db.openHelper</span><br><span class="line">        dynamicList?.let &#123;</span><br><span class="line">            dataBaseHelper.writableDatabase.delete(DataBaseHelper.dynamic_info, null, null)</span><br><span class="line">            for ((id, content, date) in dynamicList) &#123;</span><br><span class="line">                val cv = ContentValues()</span><br><span class="line">                cv.put(DataBaseHelper.id, id)</span><br><span class="line">                cv.put(DataBaseHelper.content, content)</span><br><span class="line">                cv.put(DataBaseHelper.date, date)</span><br><span class="line">                dataBaseHelper.writableDatabase.insert(DataBaseHelper.dynamic_info, SQLiteDatabase.CONFLICT_REPLACE, cv)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="将原有的SQL操作方式调整为ROOM的Dao形式"><a href="#将原有的SQL操作方式调整为ROOM的Dao形式" class="headerlink" title="将原有的SQL操作方式调整为ROOM的Dao形式"></a>将原有的SQL操作方式调整为ROOM的Dao形式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">class LocalDataSource @Inject constructor(</span><br><span class="line">        @ApplicationContext private var mContext: Context) : DataSource &#123;</span><br><span class="line"></span><br><span class="line">    private val db = Room.databaseBuilder(</span><br><span class="line">            mContext,</span><br><span class="line">            AppDatabase::class.java, &quot;dynamic.db&quot;</span><br><span class="line">    ).build()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //判断游标是否为空</span><br><span class="line">    override  fun getDynamicListFromCache(): List&lt;Dynamic&gt; &#123;</span><br><span class="line">        return db.dynamicDao().getAll()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override  fun saveDynamicToCache(dynamicList: List&lt;Dynamic&gt;?) &#123;</span><br><span class="line"></span><br><span class="line">        dynamicList?.let &#123;</span><br><span class="line">            db.dynamicDao().deleteAll()</span><br><span class="line">            db.dynamicDao().insertAll(*it.toTypedArray())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用Coroutine管理数据库的异步操作"><a href="#使用Coroutine管理数据库的异步操作" class="headerlink" title="使用Coroutine管理数据库的异步操作"></a>使用Coroutine管理数据库的异步操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Dao</span><br><span class="line">interface DynamicDao &#123;</span><br><span class="line">    @Query(&quot;SELECT * FROM dynamic_info&quot;)</span><br><span class="line">    suspend fun getAll(): List&lt;Dynamic&gt;</span><br><span class="line"></span><br><span class="line">    @Insert</span><br><span class="line">    suspend fun insertAll(vararg dynamic: Dynamic)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Query(&quot;DELETE FROM dynamic_info&quot;)</span><br><span class="line">    suspend fun deleteAll()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="调整已有的测试用例"><a href="#调整已有的测试用例" class="headerlink" title="调整已有的测试用例"></a>调整已有的测试用例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">@ExperimentalCoroutinesApi</span><br><span class="line">@RunWith(AndroidJUnit4::class)</span><br><span class="line">@MediumTest</span><br><span class="line">class LocalDataSourceTest &#123;</span><br><span class="line">    private val testDispatcher = TestCoroutineDispatcher()</span><br><span class="line"></span><br><span class="line">    @Before</span><br><span class="line">    fun setUp() &#123;</span><br><span class="line">        Dispatchers.setMain(testDispatcher)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @After</span><br><span class="line">    fun tearDown() &#123;</span><br><span class="line">        Dispatchers.resetMain()</span><br><span class="line">        testDispatcher.cleanupTestCoroutines()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    fun `should get dynamic is empty when database has not data`() = runBlocking &#123;</span><br><span class="line">        //given</span><br><span class="line">        val localDataSource = LocalDataSource(ApplicationProvider.getApplicationContext())</span><br><span class="line">        //when</span><br><span class="line">        val dynamicListFromCache = localDataSource.getDynamicListFromCache()</span><br><span class="line">        //then</span><br><span class="line">        assertThat(dynamicListFromCache).isEmpty()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    fun `should get dynamic success when database has data`() = runBlocking &#123;</span><br><span class="line">        //given</span><br><span class="line">        val localDataSource = LocalDataSource(ApplicationProvider.getApplicationContext())</span><br><span class="line">        localDataSource.saveDynamicToCache(getMockData())</span><br><span class="line">        //when</span><br><span class="line">        val dynamicListFromCache = localDataSource.getDynamicListFromCache()</span><br><span class="line">        //then</span><br><span class="line">        val dynamicOne = dynamicListFromCache[0]</span><br><span class="line">        assertThat(dynamicOne.id).isEqualTo(1)</span><br><span class="line">        assertThat(dynamicOne.content).isEqualTo(&quot;今天天气真不错！&quot;)</span><br><span class="line">        assertThat(dynamicOne.date).isEqualTo(1615963675000L)</span><br><span class="line">        val dynamicTwo = dynamicListFromCache[1]</span><br><span class="line">        assertThat(dynamicTwo.id).isEqualTo(2)</span><br><span class="line">        assertThat(dynamicTwo.content).isEqualTo(&quot;这个连续剧值得追！&quot;)</span><br><span class="line">        assertThat(dynamicTwo.date).isEqualTo(1615963688000L)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private fun getMockData(): ArrayList&lt;Dynamic&gt; &#123;</span><br><span class="line">        val dynamicList = ArrayList&lt;Dynamic&gt;()</span><br><span class="line">        dynamicList.add(Dynamic(1, &quot;今天天气真不错！&quot;, 1615963675000L))</span><br><span class="line">        dynamicList.add(Dynamic(2, &quot;这个连续剧值得追！&quot;, 1615963688000L))</span><br><span class="line">        return dynamicList</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-集成验收测试"><a href="#6-集成验收测试" class="headerlink" title="6.集成验收测试"></a>6.集成验收测试</h2><ol>
<li><p>允行Dynamic模块所有守护测试，成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./gradlew dynamicBundle:testDUT</span><br><span class="line">./gradlew dynamicDebug:testDUT</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译运行DynamicDebug出现异常如下：</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalStateException: Pre-packaged database has an invalid schema: dynamic_info(com.cloud.disk.bundle.dynamic.Dynamic).</span><br><span class="line">    Expected:</span><br><span class="line">   TableInfo&#123;name=&apos;dynamic_info&apos;, columns=&#123;date=Column&#123;name=&apos;date&apos;, type=&apos;INTEGER&apos;, affinity=&apos;3&apos;, notNull=true, primaryKeyPosition=0, defaultValue=&apos;null&apos;&#125;, content=Column&#123;name=&apos;content&apos;, type=&apos;TEXT&apos;, affinity=&apos;2&apos;, notNull=true, primaryKeyPosition=0, defaultValue=&apos;null&apos;&#125;, id=Column&#123;name=&apos;id&apos;, type=&apos;INTEGER&apos;, affinity=&apos;3&apos;, notNull=true, primaryKeyPosition=1, defaultValue=&apos;null&apos;&#125;&#125;, foreignKeys=[], indices=[]&#125;</span><br><span class="line">    Found:</span><br><span class="line">   TableInfo&#123;name=&apos;dynamic_info&apos;, columns=&#123;date=Column&#123;name=&apos;date&apos;, type=&apos;LONG&apos;, affinity=&apos;1&apos;, notNull=false, primaryKeyPosition=0, defaultValue=&apos;null&apos;&#125;, id=Column&#123;name=&apos;id&apos;, type=&apos;INTEGER&apos;, affinity=&apos;3&apos;, notNull=false, primaryKeyPosition=1, defaultValue=&apos;null&apos;&#125;, content=Column&#123;name=&apos;content&apos;, type=&apos;VARCHAR(1024)&apos;, affinity=&apos;2&apos;, notNull=false, primaryKeyPosition=0, defaultValue=&apos;null&apos;&#125;&#125;, foreignKeys=[], indices=[]&#125;</span><br><span class="line">       at androidx.room.RoomOpenHelper.checkIdentity(RoomOpenHelper.java:163)</span><br></pre></td></tr></table></figure>
<p>这是因为我们在测试阶段运行在JVM的环境上，没有提前发现数据迁移的问题。这里我们需要使用ROOM的Migration机制进行数据备份迁移。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">private val MIGRATION_1_2 = object : Migration(1, 2) &#123;</span><br><span class="line">      override fun migrate(database: SupportSQLiteDatabase) &#123;</span><br><span class="line">          database.execSQL(&quot;ALTER TABLE dynamic_info RENAME TO dynamic_info_back_up&quot;)</span><br><span class="line">          database.execSQL(&quot;CREATE TABLE dynamic_info ( id  INTEGER PRIMARY KEY NOT NULL, content TEXT NOT NULL,date INTEGER NOT NULL)&quot;)</span><br><span class="line">          database.execSQL(&quot;INSERT INTO dynamic_info (id, content,date) SELECT id, content,date FROM dynamic_info_back_up&quot;)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private val db = Room.databaseBuilder(</span><br><span class="line">          mContext,</span><br><span class="line">          AppDatabase::class.java, &quot;dynamic.db&quot;</span><br><span class="line">  ).addMigrations(MIGRATION_1_2).build()</span><br></pre></td></tr></table></figure>
<p>更多迁移及测试见<a href="https://developer.android.google.cn/training/data-storage/room/migrating-db-versions" target="_blank" rel="noopener">迁移 Room 数据库</a>、<a href="https://developer.android.google.cn/training/data-storage/room/sqlite-room-migration" target="_blank" rel="noopener">从SQlite迁移到Room</a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本篇我们分享了动态模块数据库从Sqlite迁移至Room的过程，使用框架节省编写大量的模版代码，易于维护及扩展。</p>
<p>前面CloudDisk团队已经拆分成了多仓库开发，但各个模块各自维护了第三方库。除了版本不统一、也导致打包构建时会带入多个版本的三方库。</p>
<p>下一篇，移动应用遗留系统重构（16）- Gradle依赖管理篇。我们将继续对CloudDisk的Gradle版本进行统一管理演示。</p>
<h1 id="CloudDisk示例代码"><a href="#CloudDisk示例代码" class="headerlink" title="CloudDisk示例代码"></a>CloudDisk示例代码</h1><p><a href="https://github.com/junbin1011/CloudDisk" target="_blank" rel="noopener">CloudDisk</a></p>
<h1 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h1><p><a href="https://juejin.cn/post/6943470229905211422" target="_blank" rel="noopener">移动应用遗留系统重构（1）- 开篇</a></p>
<p><a href="https://juejin.cn/post/6945313969556946980" target="_blank" rel="noopener">移动应用遗留系统重构（2）-架构篇</a></p>
<p><a href="https://juejin.cn/post/6947855094272491556" target="_blank" rel="noopener">移动应用遗留系统重构（3）-示例篇</a></p>
<p><a href="https://juejin.cn/post/6950077521790500894" target="_blank" rel="noopener">移动应用遗留系统重构（4）-分析篇</a></p>
<p><a href="https://juejin.cn/post/6952298178095874055" target="_blank" rel="noopener">移动应用遗留系统重构（5）- 重构方法篇</a></p>
<p><a href="https://juejin.cn/post/6954635678982340622" target="_blank" rel="noopener">移动应用遗留系统重构（6）- 测试篇</a></p>
<p><a href="https://juejin.cn/post/6959504791642832909" target="_blank" rel="noopener">移动应用遗留系统重构（7）- 解耦重构演示篇(一)+视频演示</a></p>
<p><a href="https://juejin.cn/post/6963214120178941983" target="_blank" rel="noopener">移动应用遗留系统重构（8）- 依赖注入篇</a></p>
<p><a href="https://juejin.cn/post/6966166367821103117" target="_blank" rel="noopener">移动应用遗留系统重构（9）- 路由篇</a></p>
<p><a href="https://juejin.cn/post/6970870458660945934" target="_blank" rel="noopener">移动应用遗留系统重构（10）- 解耦重构演示篇（二）</a></p>
<p><a href="https://juejin.cn/post/6973836199655899149" target="_blank" rel="noopener">移动应用遗留系统重构（11）- 制品管理篇</a></p>
<p><a href="https://juejin.cn/post/6974634615537401886" target="_blank" rel="noopener">移动应用遗留系统重构（12）- 编译调试篇</a></p>
<p><a href="https://juejin.cn/post/6975877150314332168" target="_blank" rel="noopener">移动应用遗留系统重构（13）- 编译调试篇</a></p>
<p><a href="https://juejin.cn/post/6975877150314332168" target="_blank" rel="noopener">移动应用遗留系统重构（13）- 编译调试篇</a></p>
<p><a href="https://juejin.cn/post/6977702335879315493" target="_blank" rel="noopener">移动应用遗留系统重构（14）- Kotlin+MVVM重构示例篇</a></p>
<h1 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h1><p><img src="https://note.youdao.com/yws/api/personal/file/WEBf483992c4f5299577eeb0c039992c8d6?method=download&amp;shareKey=fd4babce2b0d344869bb1b2f7042417d" alt=""></p>
<h1 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h1><ul>
<li>作者：黄俊彬 </li>
<li><a href="https://junbin.tech/" target="_blank" rel="noopener">博客：junbin.tech</a></li>
<li><a href="https://github.com/junbin1011" target="_blank" rel="noopener">GitHub: junbin1011 </a></li>
<li><a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" rel="noopener">知乎: @JunBin</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2021/06/24/移动应用遗留系统重构（14）-Kotlin-MVVM重构示例篇/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/06/24/移动应用遗留系统重构（14）-Kotlin-MVVM重构示例篇/" itemprop="url">
                  移动应用遗留系统重构（14）- Kotlin+MVVM重构示例篇
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-24T20:42:55+08:00">
                2021-06-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/06/24/移动应用遗留系统重构（14）-Kotlin-MVVM重构示例篇/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/06/24/移动应用遗留系统重构（14）-Kotlin-MVVM重构示例篇/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇<a href="https://juejin.cn/post/6975877150314332168" target="_blank" rel="noopener">移动应用遗留系统重构（13）-MVP重构示例篇</a>介绍了文件模块团队将文件主页重构为MVP架构，并且补充了自动化测试。经过重构后，团队的开发效率和版本质量有了明显的提升。动态模块的业务比文件模块更复杂，并且这次团队决定使用新的开发语言Kotlin及MVVM架构。</p>
<p>本篇我们将拿DynamicBundle作为例子，为大家继续演示如何从Java代码过渡为Kotlin代码，以及如何一步一步将上帝类重构演化为MVVM架构。</p>
<p><strong>视频演示地址:</strong> <a href="https://mp.weixin.qq.com/s/vex4Kn6Ts-dI3KX2Yiuq6w" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/vex4Kn6Ts-dI3KX2Yiuq6w</a></p>
<h1 id="重构流程"><a href="#重构流程" class="headerlink" title="重构流程"></a>重构流程</h1><p>从新回忆下上一篇我们分析的重构流程，对于转Kotlin语言，我们建议也做完至第3步，有了守护测试再进行转换，这样更加安全。流程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">A(1.梳理业务逻辑)--&gt;B(2.分析原有的代码设计)</span><br><span class="line">B--&gt;C(3.补充守护测试)</span><br><span class="line">C--&gt;D(4.简单设计)</span><br><span class="line">D--&gt;E(5.小步安全重构)</span><br><span class="line">E--&gt;F(6.集成验收测试)</span><br></pre></td></tr></table></figure>
<h2 id="1-梳理业务逻辑"><a href="#1-梳理业务逻辑" class="headerlink" title="1. 梳理业务逻辑"></a>1. 梳理业务逻辑</h2><p>上篇提到我们可以尝试从一下几方面来补全信息。</p>
<ol>
<li>找人：产品经理、设计人员、测试人员进行确认和答疑</li>
<li>找文档：查看原有的需求文档、设计文档、测试用例、设计稿</li>
<li>看代码：从原有的代码设计中去梳理业务</li>
</ol>
<p>经过梳理确认，FileBundle的现有的业务如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">A(进入动态页面)--&gt;B(从网络加载动态列表数据)</span><br><span class="line">B --&gt; C&#123;数据是否加载成功&#125;</span><br><span class="line">C --&gt;|加载成功| D(显示动态列表-内容和日期)</span><br><span class="line">C --&gt;|网络异常| E&#123;是否存在本地缓存数据&#125;</span><br><span class="line">C --&gt;|数据为空| F(显示empty data)</span><br><span class="line">E --&gt;|存在缓存数据|D</span><br><span class="line">E --&gt;|不存在缓存数据|G(显示NetworkErrorException)</span><br><span class="line">F --&gt;|点击触发刷新|B</span><br><span class="line">G --&gt;|点击触发刷新|B</span><br></pre></td></tr></table></figure>
<blockquote>
<p>时间转换为 yyyy-MM-dd HH:mm:ss 显示</p>
</blockquote>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB65cd0c69aad3249af7aba469f24b7747?method=download&amp;shareKey=d9c2c3005a459ecdec928d81648eedb9" alt=""></p>
<h2 id="2-分析原有的代码设计"><a href="#2-分析原有的代码设计" class="headerlink" title="2.分析原有的代码设计"></a>2.分析原有的代码设计</h2><p>我们以主要上帝类DynamicFragment为例，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">@Route(path = &quot;/dynamicBundle/dynamic&quot;)</span><br><span class="line">@AndroidEntryPoint</span><br><span class="line">public class DynamicFragment extends Fragment &#123;</span><br><span class="line"></span><br><span class="line">    @Inject</span><br><span class="line">    DynamicController dynamicController;</span><br><span class="line">    Button btnUpload;</span><br><span class="line">    @Inject</span><br><span class="line">    TransferFile transferFile;</span><br><span class="line"></span><br><span class="line">    private RecyclerView dynamicListRecycleView;</span><br><span class="line">    private TextView tvMessage;</span><br><span class="line"></span><br><span class="line">    public static DynamicFragment newInstance() &#123;</span><br><span class="line">        DynamicFragment fragment = new DynamicFragment();</span><br><span class="line">        Bundle args = new Bundle();</span><br><span class="line">        fragment.setArguments(args);</span><br><span class="line">        return fragment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public View onCreateView(LayoutInflater inflater, ViewGroup container,</span><br><span class="line">                             Bundle savedInstanceState) &#123;</span><br><span class="line">        View view = inflater.inflate(R.layout.fragment_dynamic, container, false);</span><br><span class="line">        btnUpload = view.findViewById(R.id.btn_upload);</span><br><span class="line">        btnUpload.setOnClickListener(v -&gt; uploadDynamic());</span><br><span class="line">        dynamicListRecycleView = view.findViewById(R.id.file_list);</span><br><span class="line">        tvMessage = view.findViewById(R.id.tv_message);</span><br><span class="line">        tvMessage.setOnClickListener(v -&gt; getDynamicList());</span><br><span class="line">        getDynamicList();</span><br><span class="line">        return view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void uploadDynamic() &#123;</span><br><span class="line">        //上传文件</span><br><span class="line">        FileInfo fileInfo = transferFile.upload(&quot;/data/data/user.png&quot;);</span><br><span class="line">        dynamicController.post(new Dynamic(0, &quot;第一个动态&quot;, System.currentTimeMillis()), fileInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void getDynamicList() &#123;</span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            Message message = new Message();</span><br><span class="line">            try &#123;</span><br><span class="line">                List&lt;Dynamic&gt; dynamicList = dynamicController.getDynamicList();</span><br><span class="line">                message.what = 1;</span><br><span class="line">                message.obj = dynamicList;</span><br><span class="line">            &#125; catch (NetworkErrorException e) &#123;</span><br><span class="line">                message.what = 0;</span><br><span class="line">                message.obj = &quot;NetworkErrorException&quot;;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            mHandler.sendMessage(message);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Handler mHandler = new Handler(new Handler.Callback() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public boolean handleMessage(@NonNull Message msg) &#123;</span><br><span class="line">            if (msg.what == 1) &#123;</span><br><span class="line">                showTip(false);</span><br><span class="line">                //显示网络数据</span><br><span class="line">                List&lt;Dynamic&gt; dynamicList = (List&lt;Dynamic&gt;) msg.obj;</span><br><span class="line">                if (dynamicList == null || dynamicList.size() == 0) &#123;</span><br><span class="line">                    showTip(true);</span><br><span class="line">                    //显示空数据</span><br><span class="line">                    tvMessage.setText(&quot;empty data&quot;);</span><br><span class="line"></span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    DynamicListAdapter fileListAdapter = new DynamicListAdapter(dynamicList, getActivity());</span><br><span class="line">                    dynamicListRecycleView.addItemDecoration(new DividerItemDecoration(</span><br><span class="line">                            getActivity(), DividerItemDecoration.VERTICAL));</span><br><span class="line">                    //设置布局显示格式</span><br><span class="line">                    dynamicListRecycleView.setLayoutManager(new LinearLayoutManager(getActivity()));</span><br><span class="line">                    dynamicListRecycleView.setAdapter(fileListAdapter);</span><br><span class="line">                    //从网络中更新到数据保持到缓存之中</span><br><span class="line">                    dynamicController.saveDynamicToCache(dynamicList);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (msg.what == 0) &#123;</span><br><span class="line">                //尝试从缓存中读取数据</span><br><span class="line">                List&lt;Dynamic&gt; dynamicList = dynamicController.getDynamicListFromCache();</span><br><span class="line">                if (dynamicList == null || dynamicList.size() == 0) &#123;</span><br><span class="line">                    showTip(true);</span><br><span class="line">                    //显示异常提醒数据</span><br><span class="line">                    tvMessage.setText(msg.obj.toString());</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    DynamicListAdapter fileListAdapter = new DynamicListAdapter(dynamicList, getActivity());</span><br><span class="line">                    dynamicListRecycleView.addItemDecoration(new DividerItemDecoration(</span><br><span class="line">                            getActivity(), DividerItemDecoration.VERTICAL));</span><br><span class="line">                    //设置布局显示格式</span><br><span class="line">                    dynamicListRecycleView.setLayoutManager(new LinearLayoutManager(getActivity()));</span><br><span class="line">                    dynamicListRecycleView.setAdapter(fileListAdapter);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    public void showTip(boolean show) &#123;</span><br><span class="line">        if (show) &#123;</span><br><span class="line">            tvMessage.setVisibility(View.VISIBLE);</span><br><span class="line">            dynamicListRecycleView.setVisibility(View.GONE);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            tvMessage.setVisibility(View.GONE);</span><br><span class="line">            dynamicListRecycleView.setVisibility(View.VISIBLE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从代码中我们可以看到主要的一些设计问题，如下：</p>
<ol>
<li>主要的获取动态列表、异常逻辑判断、数据缓存判断、界面刷新控制都是在一个类里面，不利于后续的扩张及修改维护。我们希望类的职责更加单一，逻辑和视图能够进行分离。</li>
<li>存在粗暴的new Thread进行管理</li>
<li>Handler 存在内存泄露风险</li>
<li>存在重复代码，例如列表数据的展示</li>
<li>代码中没有任何守护测试</li>
</ol>
<p>完整的所有代码见<a href="https://github.com/junbin1011/CloudDisk/commit/dd2abeb9000d81af340fbface4f25182ada922f0" target="_blank" rel="noopener">Github</a></p>
<h2 id="3-补充守护测试"><a href="#3-补充守护测试" class="headerlink" title="3. 补充守护测试"></a>3. 补充守护测试</h2><p>参考重构篇中，我们制定的策略，我们可以先做大型的测试，做为守护测试。同样我们会将数据库和网络相关的操作进行mock。测试用例主要包含梳理出来的主要业务逻辑，包括正常显示数据、网络异常存在缓存数据、网络异常没有缓存数据、空数据。代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(AndroidJUnit4::class)</span><br><span class="line">@LargeTest</span><br><span class="line">@HiltAndroidTest</span><br><span class="line">@Config(application = HiltTestApplication::class, shadows = [ShadowDynamicFragment::class, ShadowDynamicController::class])</span><br><span class="line">class DynamicFragmentTest &#123;</span><br><span class="line">    @get:Rule</span><br><span class="line">    var hiltRule = HiltAndroidRule(this)</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    fun `show show dynamic list when get success`() &#123;</span><br><span class="line">        //given</span><br><span class="line">        ShadowDynamicFragment.state = ShadowDynamicFragment.State.SUCCESS</span><br><span class="line">        //when</span><br><span class="line">        val scenario: ActivityScenario&lt;DebugActivity&gt; = ActivityScenario.launch(DebugActivity::class.java)</span><br><span class="line">        scenario.onActivity &#123;</span><br><span class="line">            //then</span><br><span class="line">            onView(withText(&quot;今天天气真不错！&quot;)).check(matches(isDisplayed()))</span><br><span class="line">            onView(withText(&quot;2021-03-17 14:47:55&quot;)).check(matches(isDisplayed()))</span><br><span class="line">            onView(withText(&quot;这个连续剧值得追！&quot;)).check(matches(isDisplayed()))</span><br><span class="line">            onView(withText(&quot;2021-03-17 14:48:08&quot;)).check(matches(isDisplayed()))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    fun `show show dynamic list when net work exception but have cache`() &#123;</span><br><span class="line">        //given</span><br><span class="line">        ShadowDynamicFragment.state = ShadowDynamicFragment.State.ERROR</span><br><span class="line">        ShadowDynamicController.state = ShadowDynamicController.State.DATA</span><br><span class="line">        //when</span><br><span class="line">        val scenario: ActivityScenario&lt;DebugActivity&gt; = ActivityScenario.launch(DebugActivity::class.java)</span><br><span class="line">        scenario.onActivity &#123;</span><br><span class="line">            //then</span><br><span class="line">            onView(withText(&quot;今天天气真不错！&quot;)).check(matches(isDisplayed()))</span><br><span class="line">            onView(withText(&quot;2021-03-17 14:47:55&quot;)).check(matches(isDisplayed()))</span><br><span class="line">            onView(withText(&quot;这个连续剧值得追！&quot;)).check(matches(isDisplayed()))</span><br><span class="line">            onView(withText(&quot;2021-03-17 14:48:08&quot;)).check(matches(isDisplayed()))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    fun `show show error tip when net work exception and not have cache`() &#123;</span><br><span class="line">        //given</span><br><span class="line">        ShadowDynamicFragment.state = ShadowDynamicFragment.State.ERROR</span><br><span class="line">        ShadowDynamicController.state = ShadowDynamicController.State.EMPTY</span><br><span class="line">        //when</span><br><span class="line">        val scenario: ActivityScenario&lt;DebugActivity&gt; = ActivityScenario.launch(DebugActivity::class.java)</span><br><span class="line">        scenario.onActivity &#123;</span><br><span class="line">            //then</span><br><span class="line">            onView(withText(&quot;NetworkErrorException&quot;)).check(matches(isDisplayed()))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    fun `show show empty tip when not has data`() &#123;</span><br><span class="line">        //given</span><br><span class="line">        ShadowDynamicFragment.state = ShadowDynamicFragment.State.EMPTY</span><br><span class="line">        //when</span><br><span class="line">        val scenario: ActivityScenario&lt;DebugActivity&gt; = ActivityScenario.launch(DebugActivity::class.java)</span><br><span class="line">        scenario.onActivity &#123;</span><br><span class="line">            //then</span><br><span class="line">            onView(withText(&quot;empty data&quot;)).check(matches(isDisplayed()))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后我们完成了基本的守护测试，运行结果如下：</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBa713c5f3dbbd69df2e9ae82a30852889?method=download&amp;shareKey=fa9379fdf7bc2823ecf320e842d77dfe" alt=""></p>
<p>完整的所有代码见<a href="https://github.com/junbin1011/CloudDisk/commit/b9505f96999aa24b7b82b9deedc1763e332bf4de" target="_blank" rel="noopener">Github</a></p>
<h2 id="Kotlin"><a href="#Kotlin" class="headerlink" title="Kotlin"></a><a href="https://www.kotlincn.net/docs/reference/" target="_blank" rel="noopener">Kotlin</a></h2><ol>
<li><p>Kotlin与Java支持混编，我们可以将新增的代码用Kotlin编写。详细看Kotlin官网的<a href="https://www.kotlincn.net/docs/reference/java-interop.html" target="_blank" rel="noopener">Java互操作</a></p>
</li>
<li><p>AndroidStudio支持将原有的Java代码转换为Kotlin代码<br><img src="https://note.youdao.com/yws/api/personal/file/WEB5916b63a9bf0243cff8ddd17514ef82e?method=download&amp;shareKey=1e7d24937a02af225417180bcd279599" alt=""></p>
</li>
<li><p>AndroidStudio支持将查看Kotlin的字节码，Decompile为Java代码，方便理解一些语法特性</p>
</li>
</ol>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBfb70f1af8157bdd7eb5862f6b1f1aef7?method=download&amp;shareKey=6e5e988c2313c3a70fa57ae33b9f03d8" alt=""></p>
<p>Dynamic模块团队成员决定使用2方案，将动态主页面转换为Kotlin代码。</p>
<blockquote>
<p>转化过程中，尽量一次转换一个相对内聚的包，小步转换加测试验证，转换后再人工进行Review和调整</p>
</blockquote>
<p>通过转换后，目前DynamicFragment的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">@Route(path = &quot;/dynamicBundle/dynamic&quot;)</span><br><span class="line">@AndroidEntryPoint</span><br><span class="line">class DynamicFragment : Fragment() &#123;</span><br><span class="line">    @Inject</span><br><span class="line">    lateinit var dynamicController: DynamicController</span><br><span class="line"></span><br><span class="line">    @Inject</span><br><span class="line">    lateinit var transferFile: TransferFile</span><br><span class="line"></span><br><span class="line">    private lateinit var btnUpload: Button</span><br><span class="line">    private lateinit var dynamicListRecycleView: RecyclerView</span><br><span class="line">    private lateinit var tvMessage: TextView</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?,</span><br><span class="line">                              savedInstanceState: Bundle?): View? &#123;</span><br><span class="line">        val view = inflater.inflate(R.layout.fragment_dynamic, container, false)</span><br><span class="line">        btnUpload = view.findViewById(R.id.btn_upload)</span><br><span class="line">        btnUpload.setOnClickListener &#123; uploadDynamic() &#125;</span><br><span class="line">        dynamicListRecycleView = view.findViewById(R.id.file_list)</span><br><span class="line">        tvMessage = view.findViewById(R.id.tv_message)</span><br><span class="line">        tvMessage.setOnClickListener &#123; getDynamicList() &#125;</span><br><span class="line">        getDynamicList()</span><br><span class="line">        return view</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private fun uploadDynamic() &#123;</span><br><span class="line">        //上传文件</span><br><span class="line">        val fileInfo = transferFile.upload(&quot;/data/data/user.png&quot;)</span><br><span class="line">        fileInfo?.let &#123; dynamicController.post(Dynamic(0, &quot;第一个动态&quot;, System.currentTimeMillis()), it) &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public fun getDynamicList() &#123;</span><br><span class="line">        Thread &#123;</span><br><span class="line">            val message = Message()</span><br><span class="line">            val dynamicList = dynamicController.getDynamicList()</span><br><span class="line">            message.what = 1</span><br><span class="line">            message.obj = dynamicList</span><br><span class="line">            mHandler.sendMessage(message)</span><br><span class="line">        &#125;.start()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var mHandler = Handler &#123; msg -&gt;</span><br><span class="line">        if (msg.what == 1) &#123;</span><br><span class="line">            showTip(false)</span><br><span class="line">            //显示网络数据</span><br><span class="line">            var dynamicList = mutableListOf&lt;Dynamic&gt;()</span><br><span class="line">            msg.obj?.let &#123; dynamicList = msg.obj as MutableList&lt;Dynamic&gt; &#125;</span><br><span class="line">            if (dynamicList.isEmpty()) &#123;</span><br><span class="line">                showTip(true)</span><br><span class="line">                //显示空数据</span><br><span class="line">                tvMessage.text = &quot;empty data&quot;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                val fileListAdapter = activity?.let &#123; DynamicListAdapter(dynamicList, it) &#125;</span><br><span class="line">                dynamicListRecycleView.addItemDecoration(DividerItemDecoration(</span><br><span class="line">                        activity, DividerItemDecoration.VERTICAL))</span><br><span class="line">                //设置布局显示格式</span><br><span class="line">                dynamicListRecycleView.layoutManager = LinearLayoutManager(activity)</span><br><span class="line">                dynamicListRecycleView.adapter = fileListAdapter</span><br><span class="line">                //从网络中更新到数据保持到缓存之中</span><br><span class="line">                dynamicController.saveDynamicToCache(dynamicList)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (msg.what == 0) &#123;</span><br><span class="line">            //尝试从缓存中读取数据</span><br><span class="line">            val dynamicList = dynamicController.getDynamicListFromCache()</span><br><span class="line">            if (dynamicList.isEmpty()) &#123;</span><br><span class="line">                showTip(true)</span><br><span class="line">                //显示异常提醒数据</span><br><span class="line">                tvMessage.text = msg.obj.toString()</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                val fileListAdapter = activity?.let &#123; DynamicListAdapter(dynamicList, it) &#125;</span><br><span class="line">                dynamicListRecycleView.addItemDecoration(DividerItemDecoration(</span><br><span class="line">                        activity, DividerItemDecoration.VERTICAL))</span><br><span class="line">                //设置布局显示格式</span><br><span class="line">                dynamicListRecycleView.layoutManager = LinearLayoutManager(activity)</span><br><span class="line">                dynamicListRecycleView.adapter = fileListAdapter</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        false</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fun showTip(show: Boolean) &#123;</span><br><span class="line">        if (show) &#123;</span><br><span class="line">            tvMessage.visibility = View.VISIBLE</span><br><span class="line">            dynamicListRecycleView.visibility = View.GONE</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            tvMessage.visibility = View.GONE</span><br><span class="line">            dynamicListRecycleView.visibility = View.VISIBLE</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    companion object &#123;</span><br><span class="line">        fun newInstance(): DynamicFragment &#123;</span><br><span class="line">            val fragment = DynamicFragment()</span><br><span class="line">            val args = Bundle()</span><br><span class="line">            fragment.arguments = args</span><br><span class="line">            return fragment</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-简单设计"><a href="#4-简单设计" class="headerlink" title="4. 简单设计"></a>4. 简单设计</h2><h3 id="MVVM架构"><a href="#MVVM架构" class="headerlink" title="MVVM架构"></a>MVVM架构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">B(MVVM)--&gt;A(Model)</span><br><span class="line">B--&gt;|bingding|C(View)</span><br><span class="line">C--&gt;|bingding|B</span><br></pre></td></tr></table></figure>
<ol>
<li>业务逻辑和视图分离</li>
<li>ViewModel和View之间通过binding绑定，不用定义大量的接口</li>
<li>为了更高效管理线程，团队决定使用coroutine进行线程统一管理。架构风格参考<a href="https://github.com/android/architecture-samples" target="_blank" rel="noopener">architecture-samples</a></li>
</ol>
<h3 id="LiveData数据设计"><a href="#LiveData数据设计" class="headerlink" title="LiveData数据设计"></a>LiveData数据设计</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 数据列表</span><br><span class="line"> val dynamicListLiveData: LiveData&lt;List&lt;Dynamic&gt;&gt;</span><br><span class="line">// 异常信息</span><br><span class="line"> val errorMessageLiveData: LiveData&lt;String&gt;</span><br></pre></td></tr></table></figure>
<h3 id="相关的第三方库"><a href="#相关的第三方库" class="headerlink" title="相关的第三方库"></a>相关的第三方库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">implementation &apos;androidx.core:core-ktx:1.3.2&apos;</span><br><span class="line">implementation &apos;androidx.lifecycle:lifecycle-livedata-ktx:2.3.0&apos;</span><br><span class="line">implementation &apos;androidx.lifecycle:lifecycle-viewmodel-ktx:2.3.0&apos;</span><br><span class="line">implementation &apos;org.jetbrains.kotlinx:kotlinx-coroutines-core:1.4.1&apos;</span><br><span class="line">implementation &apos;org.jetbrains.kotlinx:kotlinx-coroutines-android:1.4.1&apos;</span><br></pre></td></tr></table></figure>
<h2 id="5-小步安全重构"><a href="#5-小步安全重构" class="headerlink" title="5.小步安全重构"></a>5.小步安全重构</h2><ul>
<li>抽取DynamicFragment的业务逻辑到DynamicViewModel</li>
<li>定义LiveData数据及xml的绑定</li>
<li>抽取DymaicRepository</li>
<li>抽取DataSource接口</li>
</ul>
<blockquote>
<p>重构手法包含提取接口、移动方法、移动类、抽取方法、内联、提取变量等等。<strong>Kotlin目前IDE不支持移动方法到类</strong></p>
</blockquote>
<p>详细的演示见<a href="https://mp.weixin.qq.com/s/vex4Kn6Ts-dI3KX2Yiuq6w" target="_blank" rel="noopener">视频</a></p>
<p> 详细的代码见<a href="https://github.com/junbin1011/CloudDisk/commit/911a15c493d01dceb8ee56a0bba48fee6ad9847f" target="_blank" rel="noopener">Github</a></p>
<h3 id="补充测试用例"><a href="#补充测试用例" class="headerlink" title="补充测试用例"></a>补充测试用例</h3><ol>
<li>补充DateUtil计算日期测试</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@SmallTest</span><br><span class="line">class DateUtilTest &#123;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    fun `should return 2021-03-17 14 47 5 when input is 1615963675000L`() &#123;</span><br><span class="line">        val format = DateUtil.getDateToString(1615963675000L)</span><br><span class="line">        Assert.assertEquals(&quot;2021-03-17 14:47:55&quot;, format)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>补充MVVM业务逻辑测试</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">@ExperimentalCoroutinesApi</span><br><span class="line">@SmallTest</span><br><span class="line">class DynamicViewModelTest &#123;</span><br><span class="line">    private val testDispatcher = TestCoroutineDispatcher()</span><br><span class="line"></span><br><span class="line">    @get:Rule</span><br><span class="line">    val rule = InstantTaskExecutorRule()</span><br><span class="line"></span><br><span class="line">    @Before</span><br><span class="line">    fun setUp() &#123;</span><br><span class="line">        Dispatchers.setMain(testDispatcher)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @After</span><br><span class="line">    fun tearDown() &#123;</span><br><span class="line">        Dispatchers.resetMain()</span><br><span class="line">        testDispatcher.cleanupTestCoroutines()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    fun `show show dynamic list when get success`() = runBlocking &#123;</span><br><span class="line">        //given</span><br><span class="line">        val mockTransferFile = mock(TransferFile::class.java)</span><br><span class="line">        val mockDynamicRepository = mock(DynamicRepository::class.java)</span><br><span class="line">        `when`(mockDynamicRepository.getDynamicList()).thenReturn(getMockData())</span><br><span class="line">        val dynamicViewModel = DynamicViewModel(mockTransferFile, mockDynamicRepository)</span><br><span class="line">        //when</span><br><span class="line">        dynamicViewModel.getDynamicList()</span><br><span class="line">        //then</span><br><span class="line">        val dynamicOne = LiveDataTestUtil.getValue(dynamicViewModel.dynamicListLiveData)[0]</span><br><span class="line">        assertThat(dynamicOne.id).isEqualTo(1)</span><br><span class="line">        assertThat(dynamicOne.content).isEqualTo(&quot;今天天气真不错！&quot;)</span><br><span class="line">        assertThat(dynamicOne.date).isEqualTo(1615963675000L)</span><br><span class="line">        val dynamicTwo = LiveDataTestUtil.getValue(dynamicViewModel.dynamicListLiveData)[1]</span><br><span class="line">        assertThat(dynamicTwo.id).isEqualTo(2)</span><br><span class="line">        assertThat(dynamicTwo.content).isEqualTo(&quot;这个连续剧值得追！&quot;)</span><br><span class="line">        assertThat(dynamicTwo.date).isEqualTo(1615963688000L)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    fun `show show dynamic list when net work exception but have cache`() = runBlocking &#123;</span><br><span class="line">        //given</span><br><span class="line">        val mockTransferFile = mock(TransferFile::class.java)</span><br><span class="line">        val mockDynamicRepository = mock(DynamicRepository::class.java)</span><br><span class="line">        `when`(mockDynamicRepository.getDynamicList()).thenThrow(NetWorkErrorException::class.java)</span><br><span class="line">        `when`(mockDynamicRepository.getDynamicListFromCache()).thenReturn(getMockData())</span><br><span class="line">        val dynamicViewModel = DynamicViewModel(mockTransferFile, mockDynamicRepository)</span><br><span class="line"></span><br><span class="line">        //when</span><br><span class="line">        dynamicViewModel.getDynamicList()</span><br><span class="line">        //then</span><br><span class="line">        val dynamicOne = LiveDataTestUtil.getValue(dynamicViewModel.dynamicListLiveData)[0]</span><br><span class="line">        assertThat(dynamicOne.id).isEqualTo(1)</span><br><span class="line">        assertThat(dynamicOne.content).isEqualTo(&quot;今天天气真不错！&quot;)</span><br><span class="line">        assertThat(dynamicOne.date).isEqualTo(1615963675000L)</span><br><span class="line">        val dynamicTwo = LiveDataTestUtil.getValue(dynamicViewModel.dynamicListLiveData)[1]</span><br><span class="line">        assertThat(dynamicTwo.id).isEqualTo(2)</span><br><span class="line">        assertThat(dynamicTwo.content).isEqualTo(&quot;这个连续剧值得追！&quot;)</span><br><span class="line">        assertThat(dynamicTwo.date).isEqualTo(1615963688000L)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    fun `show show error tip when net work exception and not have cache`() = runBlocking &#123;</span><br><span class="line">        //given</span><br><span class="line">        val mockTransferFile = mock(TransferFile::class.java)</span><br><span class="line">        val mockDynamicRepository = mock(DynamicRepository::class.java)</span><br><span class="line">        `when`(mockDynamicRepository.getDynamicList()).thenThrow(NetWorkErrorException::class.java)</span><br><span class="line">        val dynamicViewModel = DynamicViewModel(mockTransferFile, mockDynamicRepository)</span><br><span class="line"></span><br><span class="line">        //when</span><br><span class="line">        dynamicViewModel.getDynamicList()</span><br><span class="line">        //then</span><br><span class="line">        val errorMessage = LiveDataTestUtil.getValue(dynamicViewModel.errorMessageLiveData)</span><br><span class="line">        assertThat(errorMessage).isEqualTo(&quot;NetWorkErrorException&quot;)</span><br><span class="line">        val dynamicList = LiveDataTestUtil.getValue(dynamicViewModel.dynamicListLiveData)</span><br><span class="line">        assertThat(dynamicList).isNull()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    fun `show show empty tip when not has data`() = runBlocking &#123;</span><br><span class="line">        //given</span><br><span class="line">        val mockTransferFile = mock(TransferFile::class.java)</span><br><span class="line">        val mockDynamicRepository = mock(DynamicRepository::class.java)</span><br><span class="line">        `when`(mockDynamicRepository.getDynamicList()).thenReturn(null)</span><br><span class="line">        val dynamicViewModel = DynamicViewModel(mockTransferFile, mockDynamicRepository)</span><br><span class="line"></span><br><span class="line">        //when</span><br><span class="line">        dynamicViewModel.getDynamicList()</span><br><span class="line">        //then</span><br><span class="line">        val dynamicList = LiveDataTestUtil.getValue(dynamicViewModel.dynamicListLiveData)</span><br><span class="line">        assertThat(dynamicList).isNull()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private fun getMockData(): ArrayList&lt;Dynamic&gt; &#123;</span><br><span class="line">        val dynamicList = ArrayList&lt;Dynamic&gt;()</span><br><span class="line">        dynamicList.add(Dynamic(1, &quot;今天天气真不错！&quot;, 1615963675000L))</span><br><span class="line">        dynamicList.add(Dynamic(2, &quot;这个连续剧值得追！&quot;, 1615963688000L))</span><br><span class="line">        return dynamicList</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>dynamic bundle所有的测试，报告如下：</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB180d3632972403daa54752a0b49271a7?method=download&amp;shareKey=f889bf81d584ac02a2e0328656739b02" alt=""></p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBd486bf877d1d108f51ab98e8540f3ea1?method=download&amp;shareKey=578698ea32c537b4e9522147e36cccb5" alt=""></p>
<h3 id="DataBinging"><a href="#DataBinging" class="headerlink" title="DataBinging"></a>DataBinging</h3><p> Fragment 改造如下：<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"> @Route(path = &quot;/dynamicBundle/dynamic&quot;)</span><br><span class="line">@AndroidEntryPoint</span><br><span class="line">class DynamicFragment : Fragment() &#123;</span><br><span class="line"></span><br><span class="line">    private lateinit var binding: FragmentDynamicBinding</span><br><span class="line">    private val dynamicViewModel: DynamicViewModel by viewModels()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?,</span><br><span class="line">                              savedInstanceState: Bundle?): View? &#123;</span><br><span class="line">        binding = FragmentDynamicBinding.inflate(inflater, container, false)</span><br><span class="line">        binding.btnUpload.setOnClickListener &#123; dynamicViewModel.uploadDynamic() &#125;</span><br><span class="line">        binding.tvMessage.setOnClickListener &#123; dynamicViewModel.getDynamicList() &#125;</span><br><span class="line">        dynamicViewModel.getDynamicList()</span><br><span class="line">        subscribeUi()</span><br><span class="line">        return binding.root</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private fun subscribeUi() &#123;</span><br><span class="line">        dynamicViewModel.dynamicListLiveData.observe(viewLifecycleOwner, &#123;</span><br><span class="line">            if (it.isNullOrEmpty()) &#123;</span><br><span class="line">                showEmptyData()</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                showDynamicList(it)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        dynamicViewModel.errorMessageLiveData.observe(viewLifecycleOwner, &#123;</span><br><span class="line">            showErrorMessage(it)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private fun showErrorMessage(errorMessage: String) &#123;</span><br><span class="line">        binding.showTip = true</span><br><span class="line">        //显示异常提醒数据</span><br><span class="line">        binding.tvMessage.text = errorMessage</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private fun showDynamicList(dynamicList: List&lt;Dynamic&gt;) &#123;</span><br><span class="line">        binding.showTip = false</span><br><span class="line">        val dynamicListAdapter = DynamicListAdapter()</span><br><span class="line">        dynamicListAdapter.submitList(dynamicList)</span><br><span class="line">        binding.dynamicList.addItemDecoration(DividerItemDecoration(</span><br><span class="line">                activity, DividerItemDecoration.VERTICAL))</span><br><span class="line">        //设置布局显示格式</span><br><span class="line">        binding.dynamicList.layoutManager = LinearLayoutManager(activity)</span><br><span class="line">        binding.dynamicList.adapter = dynamicListAdapter</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private fun showEmptyData() &#123;</span><br><span class="line">        binding.showTip = true</span><br><span class="line">        //显示空数据</span><br><span class="line">        binding.tvMessage.text = &quot;empty data&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    companion object &#123;</span><br><span class="line">        fun newInstance(): DynamicFragment &#123;</span><br><span class="line">            val fragment = DynamicFragment()</span><br><span class="line">            val args = Bundle()</span><br><span class="line">            fragment.arguments = args</span><br><span class="line">            return fragment</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;layout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;data&gt;</span><br><span class="line"></span><br><span class="line">        &lt;import type=&quot;android.view.View&quot; /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;variable</span><br><span class="line">            name=&quot;showTip&quot;</span><br><span class="line">            type=&quot;boolean&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/data&gt;</span><br><span class="line"></span><br><span class="line">    &lt;FrameLayout</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;match_parent&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;TextView</span><br><span class="line">            android:id=&quot;@+id/tv_message&quot;</span><br><span class="line">            android:layout_width=&quot;match_parent&quot;</span><br><span class="line">            android:layout_height=&quot;match_parent&quot;</span><br><span class="line">            android:gravity=&quot;center&quot;</span><br><span class="line">            android:text=&quot;&quot;</span><br><span class="line">            android:visibility=&quot;@&#123;showTip ? View.VISIBLE:View.GONE&#125;&quot; /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;androidx.recyclerview.widget.RecyclerView</span><br><span class="line">            android:id=&quot;@+id/dynamicList&quot;</span><br><span class="line">            android:layout_width=&quot;match_parent&quot;</span><br><span class="line">            android:layout_height=&quot;match_parent&quot;</span><br><span class="line">            android:visibility=&quot;@&#123;showTip ? View.GONE:View.VISIBLE&#125;&quot; /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Button</span><br><span class="line">            android:id=&quot;@+id/btn_upload&quot;</span><br><span class="line">            android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">            android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">            android:layout_gravity=&quot;right|bottom&quot;</span><br><span class="line">            android:layout_margin=&quot;10dp&quot;</span><br><span class="line">            android:text=&quot;upload&quot; /&gt;</span><br><span class="line">    &lt;/FrameLayout&gt;</span><br><span class="line"></span><br><span class="line">&lt;/layout&gt;</span><br></pre></td></tr></table></figure></p>
<p> Adapter 改造如下：<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"> class DynamicListAdapter() : ListAdapter&lt;Dynamic, DynamicListAdapter.DynamicVH&gt;(DynamicDiffCallback()) &#123;</span><br><span class="line"></span><br><span class="line">    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): DynamicVH &#123;</span><br><span class="line">        return DynamicVH(DataBindingUtil.inflate(LayoutInflater.from(parent.context), R.layout.dynamic_list_item, parent, false))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override fun onBindViewHolder(holder: DynamicVH, position: Int) &#123;</span><br><span class="line">        holder.binding.dynamic = getItem(position)</span><br><span class="line">        holder.binding.executePendingBindings()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class DynamicVH(val binding: DynamicListItemBinding) : RecyclerView.ViewHolder(binding.root)</span><br><span class="line"></span><br><span class="line">    private class DynamicDiffCallback : DiffUtil.ItemCallback&lt;Dynamic&gt;() &#123;</span><br><span class="line">        override fun areItemsTheSame(oldItem: Dynamic, newItem: Dynamic): Boolean &#123;</span><br><span class="line">            return oldItem.id == newItem.id</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        override fun areContentsTheSame(oldItem: Dynamic, newItem: Dynamic): Boolean &#123;</span><br><span class="line">            return oldItem == newItem</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;layout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;data&gt;</span><br><span class="line"></span><br><span class="line">        &lt;import type=&quot;android.view.View&quot; /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;variable</span><br><span class="line">            name=&quot;dynamic&quot;</span><br><span class="line">            type=&quot;com.cloud.disk.bundle.dynamic.Dynamic&quot; /&gt;</span><br><span class="line">    &lt;/data&gt;</span><br><span class="line"></span><br><span class="line">    &lt;FrameLayout</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        android:orientation=&quot;horizontal&quot;</span><br><span class="line">        android:padding=&quot;10dp&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;TextView</span><br><span class="line">            android:id=&quot;@+id/tv_content&quot;</span><br><span class="line">            android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">            android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">            android:layout_gravity=&quot;left&quot;</span><br><span class="line">            android:text=&quot;@&#123;dynamic.content&#125;&quot; /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;TextView</span><br><span class="line">            android:id=&quot;@+id/tv_date&quot;</span><br><span class="line">            android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">            android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">            android:layout_gravity=&quot;right&quot;</span><br><span class="line">            android:text=&quot;@&#123;dynamic.formatDate&#125;&quot; /&gt;</span><br><span class="line">    &lt;/FrameLayout&gt;</span><br><span class="line"></span><br><span class="line">&lt;/layout&gt;</span><br></pre></td></tr></table></figure></p>
<p> 详细的代码见<a href="https://github.com/junbin1011/CloudDisk/commit/0497fd86cf4efbfa4a195c92b65051817d2d4cae" target="_blank" rel="noopener">Github</a></p>
<h2 id="6-集成验收测试"><a href="#6-集成验收测试" class="headerlink" title="6.集成验收测试"></a>6.集成验收测试</h2><ol>
<li>dynamic bundle模块发布1.0.1版本</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation &apos;com.cloud.disk.bundle:dynamic:1.0.1&apos;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>其他模块同步发布修改注入问题</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation &apos;com.cloud.disk.bundle:file:1.0.2&apos;</span><br><span class="line">implementation &apos;com.cloud.disk.bundle:user:1.0.1&apos;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>执行守护测试</li>
</ol>
<p>我们发现因为binding生成的文件有异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Field &lt;com.cloud.dynamicbundle.databinding.DynamicListItemBinding.mDynamic&gt; has type &lt;com.cloud.disk.bundle.dynamic.Dynamic&gt; in (DynamicListItemBinding.java:0)</span><br><span class="line">Method &lt;com.cloud.dynamicbundle.databinding.DynamicListItemBinding.getDynamic()&gt; has return type &lt;com.cloud.disk.bundle.dynamic.Dynamic&gt; in (DynamicListItemBinding.java:0)</span><br><span class="line">Method &lt;com.cloud.dynamicbundle.databinding.DynamicListItemBinding.setDynamic(com.cloud.disk.bundle.dynamic.Dynamic)&gt; has parameter of type &lt;com.cloud.disk.bundle.dynamic.Dynamic&gt; in (DynamicListItemBinding.java:0)</span><br></pre></td></tr></table></figure>
<p>增加过滤规则<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.*com.cloud.*.databinding.*ItemBinding.*</span><br></pre></td></tr></table></figure></p>
<ol start="4">
<li>运行检查</li>
</ol>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB4cd749f21a707eab239a6ea5f1ee729c?method=download&amp;shareKey=954910ce097ab724ef647e3bc1d0c92b" alt=""></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本篇介绍了动态模块团队将动态件主页切换至Kotlin代码、重构为MVVM架构，并且补充了自动化测试。经过重构后，团队的开发效率和版本质量有了明显的提升。但本地数据库的管理依旧还是大量的sql 语句拼写，非常不利于扩展及维护，编写自动化测试也非常麻烦。</p>
<p>下一篇，移动应用遗留系统重构（15）- 数据库重构示例篇。我们将继续对数据库进行重构改造。</p>
<h1 id="CloudDisk示例代码"><a href="#CloudDisk示例代码" class="headerlink" title="CloudDisk示例代码"></a>CloudDisk示例代码</h1><p><a href="https://github.com/junbin1011/CloudDisk" target="_blank" rel="noopener">CloudDisk</a></p>
<h1 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h1><p><a href="https://juejin.cn/post/6943470229905211422" target="_blank" rel="noopener">移动应用遗留系统重构（1）- 开篇</a></p>
<p><a href="https://juejin.cn/post/6945313969556946980" target="_blank" rel="noopener">移动应用遗留系统重构（2）-架构篇</a></p>
<p><a href="https://juejin.cn/post/6947855094272491556" target="_blank" rel="noopener">移动应用遗留系统重构（3）-示例篇</a></p>
<p><a href="https://juejin.cn/post/6950077521790500894" target="_blank" rel="noopener">移动应用遗留系统重构（4）-分析篇</a></p>
<p><a href="https://juejin.cn/post/6952298178095874055" target="_blank" rel="noopener">移动应用遗留系统重构（5）- 重构方法篇</a></p>
<p><a href="https://juejin.cn/post/6954635678982340622" target="_blank" rel="noopener">移动应用遗留系统重构（6）- 测试篇</a></p>
<p><a href="https://juejin.cn/post/6959504791642832909" target="_blank" rel="noopener">移动应用遗留系统重构（7）- 解耦重构演示篇(一)+视频演示</a></p>
<p><a href="https://juejin.cn/post/6963214120178941983" target="_blank" rel="noopener">移动应用遗留系统重构（8）- 依赖注入篇</a></p>
<p><a href="https://juejin.cn/post/6966166367821103117" target="_blank" rel="noopener">移动应用遗留系统重构（9）- 路由篇</a></p>
<p><a href="https://juejin.cn/post/6970870458660945934" target="_blank" rel="noopener">移动应用遗留系统重构（10）- 解耦重构演示篇（二）</a></p>
<p><a href="https://juejin.cn/post/6973836199655899149" target="_blank" rel="noopener">移动应用遗留系统重构（11）- 制品管理篇</a></p>
<p><a href="https://juejin.cn/post/6974634615537401886" target="_blank" rel="noopener">移动应用遗留系统重构（12）- 编译调试篇</a></p>
<p><a href="https://juejin.cn/post/6975877150314332168" target="_blank" rel="noopener">移动应用遗留系统重构（13）- 编译调试篇</a></p>
<h1 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h1><p><img src="https://note.youdao.com/yws/api/personal/file/WEBf483992c4f5299577eeb0c039992c8d6?method=download&amp;shareKey=fd4babce2b0d344869bb1b2f7042417d" alt=""></p>
<h1 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h1><ul>
<li>作者：黄俊彬 </li>
<li><a href="https://junbin.tech/" target="_blank" rel="noopener">博客：junbin.tech</a></li>
<li><a href="https://github.com/junbin1011" target="_blank" rel="noopener">GitHub: junbin1011 </a></li>
<li><a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" rel="noopener">知乎: @JunBin</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2021/06/20/移动应用遗留系统重构（13）-MVP重构示例篇/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/06/20/移动应用遗留系统重构（13）-MVP重构示例篇/" itemprop="url">
                  移动应用遗留系统重构（13）- MVP重构示例篇
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-20T21:47:56+08:00">
                2021-06-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/06/20/移动应用遗留系统重构（13）-MVP重构示例篇/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/06/20/移动应用遗留系统重构（13）-MVP重构示例篇/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇<a href="https://juejin.cn/post/6974634615537401886" target="_blank" rel="noopener">移动应用遗留系统重构（12）- 编译调试篇</a><br>介绍，经过了解耦、分库及编译调试的优化，一段时间内，CloudDisk的开发效率得到了很大的提升。</p>
<p>但随着业务的演进，由于历史的原因，代码中存在很多Activity及Controller的上帝类。今天我们将拿File Bundle作为例子，为大家总结重构的流程，演示如何一步一步将上帝类重构演化为MVP架构。</p>
<p><strong>视频演示地址:</strong> <a href="https://mp.weixin.qq.com/s/zjeln_eqAN45CDbSrWjLaA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/zjeln_eqAN45CDbSrWjLaA</a></p>
<h1 id="重构流程"><a href="#重构流程" class="headerlink" title="重构流程"></a>重构流程</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">A(1.梳理业务逻辑)--&gt;B(2.分析原有的代码设计)</span><br><span class="line">B--&gt;C(3.补充守护测试)</span><br><span class="line">C--&gt;D(4.简单设计)</span><br><span class="line">D--&gt;E(5.小步安全重构)</span><br><span class="line">E--&gt;F(6.集成验收测试)</span><br></pre></td></tr></table></figure>
<h2 id="1-梳理业务逻辑"><a href="#1-梳理业务逻辑" class="headerlink" title="1. 梳理业务逻辑"></a>1. 梳理业务逻辑</h2><p>通过往往这一步是最难的。由于人员更迭、产品的迭代，给这一步带来很大的挑战。我们可以尝试从一下几方面来补全信息。</p>
<ol>
<li>找人：产品经理、设计人员、测试人员进行确认和答疑</li>
<li>找文档：查看原有的需求文档、设计文档、测试用例、设计稿</li>
<li>看代码：从原有的代码设计中去梳理业务</li>
</ol>
<p>经过梳理确认，File Bundle的现有的业务如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">A(进入文件页面)--&gt;B(从网络加载文件列表数据)</span><br><span class="line">B --&gt; C&#123;数据是否加载成功&#125;</span><br><span class="line">C --&gt;|加载成功| D(显示文件列表-文件名和文件大小)</span><br><span class="line">C --&gt;|网络异常| E(显示NetworkErrorException)</span><br><span class="line">C --&gt;|数据为空| F(显示empty data)</span><br><span class="line">E --&gt;|点击触发刷新|B</span><br><span class="line">F --&gt;|点击触发刷新|B</span><br></pre></td></tr></table></figure>
<blockquote>
<p>文件大小转换为以B、K、M、G单位显示</p>
</blockquote>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB35e7a645210febdfcdd0128513e7e99a?method=download&amp;shareKey=d85ce28627621acfbf824411296471cb" alt=""></p>
<h2 id="2-分析原有的代码设计"><a href="#2-分析原有的代码设计" class="headerlink" title="2.分析原有的代码设计"></a>2.分析原有的代码设计</h2><p>我们以主要上帝类FileFragment为例，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">@AndroidEntryPoint</span><br><span class="line">public class FileFragment extends Fragment &#123;</span><br><span class="line"></span><br><span class="line">    @Inject</span><br><span class="line">    FileController fileController;</span><br><span class="line"></span><br><span class="line">    private RecyclerView fileListRecycleView;</span><br><span class="line">    private TextView tvMessage;</span><br><span class="line"></span><br><span class="line">    public static FileFragment newInstance() &#123;</span><br><span class="line">        FileFragment fragment = new FileFragment();</span><br><span class="line">        Bundle args = new Bundle();</span><br><span class="line">        fragment.setArguments(args);</span><br><span class="line">        return fragment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public View onCreateView(LayoutInflater inflater, ViewGroup container,</span><br><span class="line">                             Bundle savedInstanceState) &#123;</span><br><span class="line"></span><br><span class="line">        View view = inflater.inflate(R.layout.fragment_file, container, false);</span><br><span class="line">        fileListRecycleView = view.findViewById(R.id.file_list);</span><br><span class="line">        tvMessage = view.findViewById(R.id.tv_message);</span><br><span class="line">        tvMessage.setOnClickListener(v -&gt; getFileList());</span><br><span class="line">        return view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        getFileList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void getFileList() &#123;</span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            Message message = new Message();</span><br><span class="line">            try &#123;</span><br><span class="line">                List&lt;FileInfo&gt; infoList = fileController.getFileList();</span><br><span class="line">                message.what = 1;</span><br><span class="line">                message.obj = infoList;</span><br><span class="line">            &#125; catch (NetworkErrorException e) &#123;</span><br><span class="line">                message.what = 0;</span><br><span class="line">                message.obj = &quot;NetworkErrorException&quot;;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            mHandler.sendMessage(message);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Handler mHandler = new Handler(new Handler.Callback() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public boolean handleMessage(@NonNull Message msg) &#123;</span><br><span class="line">            if (msg.what == 1) &#123;</span><br><span class="line">                showTip(false);</span><br><span class="line">                //显示网络数据</span><br><span class="line">                List&lt;FileInfo&gt; infoList = (List&lt;FileInfo&gt;) msg.obj;</span><br><span class="line">                FileListAdapter fileListAdapter = new FileListAdapter(infoList, getActivity());</span><br><span class="line">                fileListRecycleView.addItemDecoration(new DividerItemDecoration(</span><br><span class="line">                        getActivity(), DividerItemDecoration.VERTICAL));</span><br><span class="line">                //设置布局显示格式</span><br><span class="line">                fileListRecycleView.setLayoutManager(new LinearLayoutManager(getActivity()));</span><br><span class="line">                fileListRecycleView.setAdapter(fileListAdapter);</span><br><span class="line">            &#125; else if (msg.what == 0) &#123;</span><br><span class="line">                showTip(true);</span><br><span class="line">                //显示异常提醒数据</span><br><span class="line">                tvMessage.setText(msg.obj.toString());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                showTip(true);</span><br><span class="line">                //显示空数据</span><br><span class="line">                tvMessage.setText(&quot;empty data&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    public void showTip(boolean show) &#123;</span><br><span class="line">        if (show) &#123;</span><br><span class="line">            tvMessage.setVisibility(View.VISIBLE);</span><br><span class="line">            fileListRecycleView.setVisibility(View.GONE);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            tvMessage.setVisibility(View.GONE);</span><br><span class="line">            fileListRecycleView.setVisibility(View.VISIBLE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从代码中我们可以看到主要的一些设计问题，如下：</p>
<ol>
<li>主要的获取文件、异常逻辑判断、界面刷新控制都是在一个类里面，不利于后续的扩张及修改维护。我们希望类的职责更加单一，逻辑和视图能够进行分离。</li>
<li>存在粗暴的new Thread进行管理</li>
<li>Handler 存在内存泄露风险</li>
<li>存在规范问题，例如empty data字符串没有使用xml进行管理、代码中由无效的导包等</li>
<li>代码中没有任何守护测试</li>
</ol>
<p>完整的所有代码见<a href="https://github.com/junbin1011/CloudDisk/commit/3c4c4d98bcef46357f4c653431dc53e6d691e397" target="_blank" rel="noopener">Github</a></p>
<h2 id="3-补充守护测试"><a href="#3-补充守护测试" class="headerlink" title="3. 补充守护测试"></a>3. 补充守护测试</h2><p>参考重构篇中，我们制定的策略，我们可以先做大型的测试，做为守护测试。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(AndroidJUnit4.class)</span><br><span class="line">@LargeTest</span><br><span class="line">@HiltAndroidTest</span><br><span class="line">@Config(application = HiltTestApplication.class)</span><br><span class="line">public class FileFragmentTest &#123;</span><br><span class="line"></span><br><span class="line">    @Rule</span><br><span class="line">    public HiltAndroidRule hiltRule = new HiltAndroidRule(this);</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void show_show_file_list_when_get_success() &#123;</span><br><span class="line">        //given</span><br><span class="line">        ActivityScenario&lt;DebugActivity&gt; scenario = ActivityScenario.launch(DebugActivity.class);</span><br><span class="line">        scenario.onActivity(activity -&gt; &#123;</span><br><span class="line">            //then</span><br><span class="line">            onView(withText(&quot;遗留代码重构.pdf&quot;)).check(matches(isDisplayed()));</span><br><span class="line">            onView(withText(&quot;100.00K&quot;)).check(matches(isDisplayed()));</span><br><span class="line">            onView(withText(&quot;系统组件化.pdf&quot;)).check(matches(isDisplayed()));</span><br><span class="line">            onView(withText(&quot;9.67K&quot;)).check(matches(isDisplayed()));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>我们发现这个用不会通过，我们主要面临一下2个问题。</strong></p>
<ol>
<li>网络请求是异步的，异步逻辑可能在测试执行完还没有触发到</li>
<li>网络数据是动态的，我们断言的数据没办法确定</li>
</ol>
<p>所以我们采用的做法就是Mock，我不稳定的依赖Mock掉。我们同样使用Shadow来进行多获取网络数据方法进行Mock，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@Implements(FileFragment.class)</span><br><span class="line">public class ShadowFileFragment &#123;</span><br><span class="line"></span><br><span class="line">    @RealObject</span><br><span class="line">    public FileFragment fileFragment;</span><br><span class="line"></span><br><span class="line">    enum State &#123;</span><br><span class="line">        SUCCESS,</span><br><span class="line">        ERROR,</span><br><span class="line">        EMPTY</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static State state = State.SUCCESS;</span><br><span class="line"></span><br><span class="line">    @Implementation</span><br><span class="line">    protected void getFileList() &#123;</span><br><span class="line">        System.out.println(&quot;shadow .... .....&quot;);</span><br><span class="line">        Message message = new Message();</span><br><span class="line">        if (state == State.SUCCESS) &#123;</span><br><span class="line">            ArrayList&lt;FileInfo&gt; infoList = new ArrayList&lt;&gt;();</span><br><span class="line">            infoList.add(new FileInfo(&quot;遗留代码重构.pdf&quot;, 102400));</span><br><span class="line">            infoList.add(new FileInfo(&quot;系统组件化.pdf&quot;, 9900));</span><br><span class="line">            message.what = 1;</span><br><span class="line">            message.obj = infoList;</span><br><span class="line">        &#125; else if (state == State.ERROR) &#123;</span><br><span class="line">            message.what = 0;</span><br><span class="line">            message.obj = &quot;NetworkErrorException&quot;;</span><br><span class="line">        &#125; else if (state == State.EMPTY) &#123;</span><br><span class="line">            message.what = 1;</span><br><span class="line">            message.obj = null;</span><br><span class="line">        &#125;</span><br><span class="line">        fileFragment.mHandler.sendMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调整后的测试用例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">   public void show_show_file_list_when_get_success() &#123;</span><br><span class="line">       //given</span><br><span class="line">       ShadowFileFragment.state = ShadowFileFragment.State.SUCCESS;</span><br><span class="line">       //when</span><br><span class="line">       ActivityScenario&lt;DebugActivity&gt; scenario = ActivityScenario.launch(DebugActivity.class);</span><br><span class="line">       scenario.onActivity(activity -&gt; &#123;</span><br><span class="line">           //then</span><br><span class="line">           onView(withText(&quot;遗留代码重构.pdf&quot;)).check(matches(isDisplayed()));</span><br><span class="line">           onView(withText(&quot;100.00K&quot;)).check(matches(isDisplayed()));</span><br><span class="line">           onView(withText(&quot;系统组件化.pdf&quot;)).check(matches(isDisplayed()));</span><br><span class="line">           onView(withText(&quot;9.67K&quot;)).check(matches(isDisplayed()));</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   @Test</span><br><span class="line">   public void show_show_error_tip_when_net_work_exception() &#123;</span><br><span class="line">       //given</span><br><span class="line">       ShadowFileFragment.state = ShadowFileFragment.State.ERROR;</span><br><span class="line">       //when</span><br><span class="line">       ActivityScenario&lt;DebugActivity&gt; scenario = ActivityScenario.launch(DebugActivity.class);</span><br><span class="line">       scenario.onActivity(activity -&gt; &#123;</span><br><span class="line">           //then</span><br><span class="line">           onView(withText(&quot;NetworkErrorException&quot;)).check(matches(isDisplayed()));</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   @Test</span><br><span class="line">   public void show_show_empty_tip_when_not_has_data() &#123;</span><br><span class="line">       //given</span><br><span class="line">       ShadowFileFragment.state = ShadowFileFragment.State.EMPTY;</span><br><span class="line">       //when</span><br><span class="line">       ActivityScenario&lt;DebugActivity&gt; scenario = ActivityScenario.launch(DebugActivity.class);</span><br><span class="line">       scenario.onActivity(activity -&gt; &#123;</span><br><span class="line">           //then</span><br><span class="line">           onView(withText(&quot;empty data&quot;)).check(matches(isDisplayed()));</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>中间我们用允许测试脚步时发现，之前的旧代码还有一处逻辑的错误。数据为空的判断应该加在网络数据回调中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.NullPointerException</span><br><span class="line">	at com.cloud.disk.bundle.file.FileFragment$1.handleMessage(FileFragment.java:96)</span><br><span class="line">	at android.os.Handler.dispatchMessage(Handler.java:102)</span><br></pre></td></tr></table></figure>
<p>我们同步将异常逻辑进行修改，如下：</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB3ed18d4895f56ea4bd63edb07bad1ebb?method=download&amp;shareKey=9866d947d7c8cc33cf4c0f281ecb594c" alt=""></p>
<p>最后我们完成了基本的守护测试，运行结果如下：</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB2b366b7e072c92fb0690c2566ddf10a4?method=download&amp;shareKey=92b33d82fb51a71726529c783b9c736c" alt=""></p>
<p>完整的所有代码见<a href="https://github.com/junbin1011/CloudDisk/commit/3c4c4d98bcef46357f4c653431dc53e6d691e397" target="_blank" rel="noopener">Github</a></p>
<h2 id="4-简单设计"><a href="#4-简单设计" class="headerlink" title="4. 简单设计"></a>4. 简单设计</h2><h3 id="MVP架构"><a href="#MVP架构" class="headerlink" title="MVP架构"></a>MVP架构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">B(Presenter)--&gt;A(Model)</span><br><span class="line">B--&gt;|interface|C(View)</span><br><span class="line">C--&gt;|interface|B</span><br></pre></td></tr></table></figure>
<ol>
<li>业务逻辑和视图分离</li>
<li>Presenter和View之间通过接口交互</li>
<li>为了更高效管理线程，团队决定使用Rxjava进行线程统一管理。架构风格参考<a href="https://github.com/android/architecture-samples" target="_blank" rel="noopener">architecture-samples</a></li>
</ol>
<h3 id="接口设计"><a href="#接口设计" class="headerlink" title="接口设计"></a>接口设计</h3><ol>
<li>Contract接口设计</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public interface FileListContract &#123;</span><br><span class="line"></span><br><span class="line">    interface View  &#123;</span><br><span class="line">        showFileList(List&lt;FileInfo&gt; fileList);</span><br><span class="line">        showNetWorkException(String errorMessage);</span><br><span class="line">        showEmptyData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    interface Presenter &#123;</span><br><span class="line"></span><br><span class="line">        void getFileList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>数据接口设计</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface FileDataSource &#123;</span><br><span class="line">     Flowable&lt;List&lt;FileInfo&gt;&gt; getFileList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-小步安全重构"><a href="#5-小步安全重构" class="headerlink" title="5.小步安全重构"></a>5.小步安全重构</h2><ul>
<li>抽取FileFragment的业务逻辑到FilePresenter</li>
<li>FileFragment 提取UI接口</li>
<li>抽取FileDataSource</li>
</ul>
<blockquote>
<p>重构手法包含提取接口、移动方法、移动类、抽取方法、内联、提取变量等等。<strong>过程还需要根据重构适当调整测试用例。</strong></p>
</blockquote>
<p>详细的演示见<a href="https://mp.weixin.qq.com/s/zjeln_eqAN45CDbSrWjLaA" target="_blank" rel="noopener">视频</a></p>
<ul>
<li>补充测试用例</li>
</ul>
<ol>
<li>补充FileUtils计算文件大小测试</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(JUnit4.class)</span><br><span class="line">@SmallTest</span><br><span class="line">public class FileUtilsTest &#123;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void should_return_B_unit_when_file_size_in_its_range() &#123;</span><br><span class="line">        //given</span><br><span class="line">        long fileSize = 100;</span><br><span class="line">        //when</span><br><span class="line">        String format = FileUtils.formatFileSize(fileSize);</span><br><span class="line">        //then</span><br><span class="line">        assertEquals(&quot;100.00B&quot;, format);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void should_return_K_unit_when_file_size_in_its_range() &#123;</span><br><span class="line">        //given</span><br><span class="line">        long fileSize = 1034;</span><br><span class="line">        //when</span><br><span class="line">        String format = FileUtils.formatFileSize(fileSize);</span><br><span class="line">        //then</span><br><span class="line">        assertEquals(&quot;1.01K&quot;, format);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void should_return_M_unit_when_file_size_in_its_range() &#123;</span><br><span class="line">        //given</span><br><span class="line">        long fileSize = 1084000;</span><br><span class="line">        //when</span><br><span class="line">        String format = FileUtils.formatFileSize(fileSize);</span><br><span class="line">        //then</span><br><span class="line">        assertEquals(&quot;1.03M&quot;, format);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void should_return_G_unit_when_file_size_in_its_range() &#123;</span><br><span class="line">        //given</span><br><span class="line">        long fileSize = 1114000000;</span><br><span class="line">        //when</span><br><span class="line">        String format = FileUtils.formatFileSize(fileSize);</span><br><span class="line">        //then</span><br><span class="line">        assertEquals(&quot;1.04G&quot;, format);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>补充Presenter业务逻辑测试</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(JUnit4.class)</span><br><span class="line">@MediumTest</span><br><span class="line">public class FilePresenterImplTest &#123;</span><br><span class="line"></span><br><span class="line">    @Rule</span><br><span class="line">    public RxSchedulerRule rule = new RxSchedulerRule();</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void should_return_file_list_when_call_data_source_success() throws NetworkErrorException &#123;</span><br><span class="line">        //given</span><br><span class="line">        FileListContract.View mockView = mock(FileListContract.View.class);</span><br><span class="line">        FileDataSource mockFileDataSource = mock(FileDataSource.class);</span><br><span class="line">        List&lt;FileInfo&gt; fileList = new ArrayList&lt;&gt;();</span><br><span class="line">        fileList.add(new FileInfo(&quot;遗留代码重构.pdf&quot;, 102400));</span><br><span class="line">        fileList.add(new FileInfo(&quot;系统组件化.pdf&quot;, 9900));</span><br><span class="line">        when(mockFileDataSource.getFileList()).thenReturn(Flowable.fromArray(fileList));</span><br><span class="line">        FileListContract.FilePresenter filePresenter = new FilePresenterImpl(mockFileDataSource, mockView);</span><br><span class="line">        //when</span><br><span class="line">        filePresenter.getFileList();</span><br><span class="line">        //then</span><br><span class="line">        verify(mockView).showFileList(anyList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void should_show_empty_data_when_call_data_source_return_empty() throws NetworkErrorException &#123;</span><br><span class="line">        //given</span><br><span class="line">        FileListContract.View mockView = mock(FileListContract.View.class);</span><br><span class="line">        FileDataSource mockFileDataSource = mock(FileDataSource.class);</span><br><span class="line">        when(mockFileDataSource.getFileList()).thenReturn(Flowable.fromArray(new ArrayList&lt;&gt;()));</span><br><span class="line">        FileListContract.FilePresenter filePresenter = new FilePresenterImpl(mockFileDataSource, mockView);</span><br><span class="line">        //when</span><br><span class="line">        filePresenter.getFileList();</span><br><span class="line">        //then</span><br><span class="line">        verify(mockView).showEmptyData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void should_show_network_exception_when_call_data_source_return_net_error() throws NetworkErrorException &#123;</span><br><span class="line">        //given</span><br><span class="line">        FileListContract.View mockView = mock(FileListContract.View.class);</span><br><span class="line">        FileDataSource mockFileDataSource = mock(FileDataSource.class);</span><br><span class="line">        when(mockFileDataSource.getFileList()).thenThrow(new NetworkErrorException());</span><br><span class="line">        FileListContract.FilePresenter filePresenter = new FilePresenterImpl(mockFileDataSource, mockView);</span><br><span class="line">        //when</span><br><span class="line">        filePresenter.getFileList();</span><br><span class="line">        //then</span><br><span class="line">        verify(mockView).showNetWorkException(&quot;NetworkErrorException&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以通过查看Coverage查看逻辑的覆盖情况，判断是否有重要的逻辑遗漏。</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB063f4dc76efadbe40d7237dee658789c?method=download&amp;shareKey=13d6cb5293d2a24ae4baf68faf451f4a" alt=""></p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB86d045ecd69b94b80d506b5650f654da?method=download&amp;shareKey=94a3c10d2650745ed2a43cac6b9b4844" alt=""></p>
<p>最后我们运行file bundle所有的测试，报告如下：</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB3302856f2173afb539302fd0984d486c?method=download&amp;shareKey=a629e50540002ea88b95a7e22b8dba05" alt=""></p>
<h2 id="6-集成验收测试"><a href="#6-集成验收测试" class="headerlink" title="6.集成验收测试"></a>6.集成验收测试</h2><ol>
<li>file bundle模块发布1.0.1版本</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation &apos;com.cloud.disk.bundle:file:1.0.1&apos;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>执行守护测试</li>
</ol>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBb009be62841a634f0ff0d53a8ff079ad?method=download&amp;shareKey=ac5814fe21a5edc573a553b26019e40a" alt=""></p>
<ol start="3">
<li>运行检查</li>
</ol>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBa09296d62bd00f5198a775dbccba6842?method=download&amp;shareKey=732250036f72eb8c663f5950617d8b72" alt=""></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本篇介绍了文件模块团队将文件主页重构为MVP架构，并且补充了自动化测试。经过重构后，团队的开发效率和版本质量有了明显的提升。有了文件模块的打样，给其他团队带来了很大的信心。</p>
<p>接下来，我们将继续分享动态模块的重构之旅。与文件模块不一样的是动态模块决定采用Kotlin+MVVM架构。</p>
<p>下一篇，单体移动应用“模块化”演进之旅（14）- Kotlin+MVVM重构示例篇</p>
<h1 id="CloudDisk示例代码"><a href="#CloudDisk示例代码" class="headerlink" title="CloudDisk示例代码"></a>CloudDisk示例代码</h1><p><a href="https://github.com/junbin1011/CloudDisk" target="_blank" rel="noopener">CloudDisk</a></p>
<h1 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h1><p><a href="https://juejin.cn/post/6943470229905211422" target="_blank" rel="noopener">移动应用遗留系统重构（1）- 开篇</a></p>
<p><a href="https://juejin.cn/post/6945313969556946980" target="_blank" rel="noopener">移动应用遗留系统重构（2）-架构篇</a></p>
<p><a href="https://juejin.cn/post/6947855094272491556" target="_blank" rel="noopener">移动应用遗留系统重构（3）-示例篇</a></p>
<p><a href="https://juejin.cn/post/6950077521790500894" target="_blank" rel="noopener">移动应用遗留系统重构（4）-分析篇</a></p>
<p><a href="https://juejin.cn/post/6952298178095874055" target="_blank" rel="noopener">移动应用遗留系统重构（5）- 重构方法篇</a></p>
<p><a href="https://juejin.cn/post/6954635678982340622" target="_blank" rel="noopener">移动应用遗留系统重构（6）- 测试篇</a></p>
<p><a href="https://juejin.cn/post/6959504791642832909" target="_blank" rel="noopener">移动应用遗留系统重构（7）- 解耦重构演示篇(一)+视频演示</a></p>
<p><a href="https://juejin.cn/post/6963214120178941983" target="_blank" rel="noopener">移动应用遗留系统重构（8）- 依赖注入篇</a></p>
<p><a href="https://juejin.cn/post/6966166367821103117" target="_blank" rel="noopener">移动应用遗留系统重构（9）- 路由篇</a></p>
<p><a href="https://juejin.cn/post/6970870458660945934" target="_blank" rel="noopener">移动应用遗留系统重构（10）- 解耦重构演示篇（二）</a></p>
<p><a href="https://juejin.cn/post/6973836199655899149" target="_blank" rel="noopener">移动应用遗留系统重构（11）- 制品管理篇</a></p>
<p><a href="https://juejin.cn/post/6974634615537401886" target="_blank" rel="noopener">移动应用遗留系统重构（12）- 编译调试篇</a></p>
<h1 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h1><p><img src="https://note.youdao.com/yws/api/personal/file/WEBf483992c4f5299577eeb0c039992c8d6?method=download&amp;shareKey=fd4babce2b0d344869bb1b2f7042417d" alt=""></p>
<h1 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h1><ul>
<li>作者：黄俊彬 </li>
<li><a href="https://junbin.tech/" target="_blank" rel="noopener">博客：junbin.tech</a></li>
<li><a href="https://github.com/junbin1011" target="_blank" rel="noopener">GitHub: junbin1011 </a></li>
<li><a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" rel="noopener">知乎: @JunBin</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2021/06/17/移动应用遗留系统重构（12）-编译调试篇/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/06/17/移动应用遗留系统重构（12）-编译调试篇/" itemprop="url">
                  移动应用遗留系统重构（12）- 编译调试篇
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-17T13:34:23+08:00">
                2021-06-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/06/17/移动应用遗留系统重构（12）-编译调试篇/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/06/17/移动应用遗留系统重构（12）-编译调试篇/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇<a href="https://juejin.cn/post/6973836199655899149" target="_blank" rel="noopener">移动应用遗留系统重构（11）- 制品管理篇</a>我们完成通过本地maven进行二进制管理改造。在架构设计中App模块是整体工程的集成，用于进行最后的发布。业务Bundle在独立的仓库中维护，并且Bundle都是以Lib的形式存在，我们需要能够对各个业务Bundle进行独立的调试开发。</p>
<p>本篇我们将继续对CloudDisk进行改造，支持Bundle进行独立的调试。</p>
<h1 id="调试方式"><a href="#调试方式" class="headerlink" title="调试方式"></a>调试方式</h1><h2 id="1-支持Lib及Application切换"><a href="#1-支持Lib及Application切换" class="headerlink" title="1. 支持Lib及Application切换"></a>1. 支持Lib及Application切换</h2><p>我们可以通过配置Gradle的形式，让Module支持Lib及Application的调试，这样既可以满足运行调试，也可以满足发布aar。但是缺点是Gradle要进行配置，并且调试代码和正式代码都在一个工程中。</p>
<p>我们以FileBundle为例，Gradle配置情况如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//gradle 文件修改如下</span><br><span class="line"></span><br><span class="line">def isApp = false</span><br><span class="line">if (isApp) &#123;</span><br><span class="line">    //可运行</span><br><span class="line">    apply plugin: &apos;com.android.application&apos;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    //作为库</span><br><span class="line">    apply plugin: &apos;com.android.library&apos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">defaultConfig &#123;</span><br><span class="line">    if (isApp) &#123;</span><br><span class="line">        applicationId &apos;com.cloud.filebundle&apos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在src下新增debug目录，这样当打debug包时，该目录下的代码也会一起打包，当打release包时，则不会带上。这样也可方便把测试代码区分开。</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBad903ad0ddc75d48b758b2d0664b3d43?method=download&amp;shareKey=e7087a218e722efbc5e1b84016fb82af" alt=""></p>
<p>我们直接把FileFragment在DebugActivity中显示出来，运行情况如下：</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB34c9bae2106ecb62a82ced05df862b59?method=download&amp;shareKey=259472e0c054c2d511a507096a228f69" alt=""></p>
<p>完整代码示例见<a href="https://github.com/junbin1011/CloudDisk/commit/7ed0b1e3eff0d40708bcd60e5d0a34cd2b8f1f00" target="_blank" rel="noopener">Github</a></p>
<h2 id="2-新增Debug工程用于调试"><a href="#2-新增Debug工程用于调试" class="headerlink" title="2. 新增Debug工程用于调试"></a>2. 新增Debug工程用于调试</h2><p>接下来我们通过DynamicBundle进行演示，新增一个module用于专门调试,这种做法的好处是测试代码完全隔离。</p>
<p>新建名为DynamicDebug的Module，加上对于的依赖，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation &apos;com.cloud.disk:api:1.0.0&apos;</span><br><span class="line">implementation project(&apos;:dynamicBundle&apos;)</span><br></pre></td></tr></table></figure></p>
<p>同样新增DebugActivity用于调试DynamicFragment。</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBcc3ffadbe426a373939a81c16c388aae?method=download&amp;shareKey=2807899d9d699d2274bfce60e387e70e" alt=""></p>
<p>但运行调试发现编译出错，具体的日志如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">error: [Dagger/MissingBinding] com.cloud.disk.api.file.TransferFile cannot be provided without an @Provides-annotated method.</span><br><span class="line"> public abstract static class ApplicationC implements DebugApplication_GeneratedInjector,</span><br><span class="line">                        ^</span><br><span class="line">     com.cloud.disk.api.file.TransferFile is injected at</span><br><span class="line">         com.cloud.disk.bundle.dynamic.DynamicFragment.transferFile</span><br><span class="line">     com.cloud.disk.bundle.dynamic.DynamicFragment is injected at</span><br><span class="line">         com.cloud.disk.bundle.dynamic.DynamicFragment_GeneratedInjector.injectDynamicFragment(com.cloud.disk.bundle.dynamic.DynamicFragment) [com.cloud.dynamicdebug.DebugApplication_HiltComponents.ApplicationC → com.cloud.dynamicdebug.DebugApplication_HiltComponents.ActivityRetainedC → com.cloud.dynamicdebug.DebugApplication_HiltComponents.ActivityC → com.cloud.dynamicdebug.DebugApplication_HiltComponents.FragmentC]</span><br><span class="line"> It is also requested at:</span><br><span class="line">     com.cloud.disk.bundle.dynamic.DynamicController.transferFile</span><br></pre></td></tr></table></figure>
<p>因为DynamicBundle运行需要依赖TransferFile及UseState接口的实现，这个时候DynamicBundle我们独立调试，并没有将接口的实现加载进来。<strong>这个时候我们建议的做法是采用Mock，不再把具体的实现加载进来。</strong></p>
<p>新增TransferFile及UseState的接口Mock如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Module</span><br><span class="line">@InstallIn(ActivityComponent.class)</span><br><span class="line">public abstract class MockFileModule &#123;</span><br><span class="line">    @Binds</span><br><span class="line">    public abstract TransferFile bindTransferFile(</span><br><span class="line">            MockTransferFileImpl transferFileImpl</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class MockTransferFileImpl implements TransferFile &#123;</span><br><span class="line">    @Inject</span><br><span class="line">    public MockTransferFileImpl() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public FileInfo upload(String s) &#123;</span><br><span class="line">        return new FileInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public FileInfo download(String s) &#123;</span><br><span class="line">        return new FileInfo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Module</span><br><span class="line">@InstallIn(ActivityComponent.class)</span><br><span class="line">public abstract class MockUserModule &#123;</span><br><span class="line">    @Binds</span><br><span class="line">    public abstract UserState bindUserState(</span><br><span class="line">            MockUserStateImpl userStateImpl</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class MockUserStateImpl implements UserState &#123;</span><br><span class="line">    @Inject</span><br><span class="line">    public MockUserStateImpl() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getUserId() &#123;</span><br><span class="line">        return &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean isLogin() &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>增加mock后，编译正常，运行结果如下：</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB907c6fd5efd1d47e1a418063ce4762d1?method=download&amp;shareKey=b3cdc5d2689eacc93193c4be84e18a74" alt=""></p>
<p>完整代码示例见<a href="https://github.com/junbin1011/CloudDisk/commit/b868d2514aed69f1b6fab79e3a047ce8c5c63b2d" target="_blank" rel="noopener">Github</a></p>
<h2 id="3-自动化测试"><a href="#3-自动化测试" class="headerlink" title="3. 自动化测试"></a>3. 自动化测试</h2><p>这是非常推荐的一种方式，可重复执行且反馈速度快。前面我们已经有一组冒烟测试的示例。接下来介绍对userBundle的UserCenterFragment进行测试，我们同样使用Robolectric提高反馈的速度。</p>
<p>Gradle增加依赖配置，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">testImplementation &apos;junit:junit:4.13.2&apos;</span><br><span class="line">testImplementation &quot;com.google.truth:truth:1.0.1&quot;</span><br><span class="line">testImplementation &apos;com.tngtech.archunit:archunit-junit4:0.15.0&apos;</span><br><span class="line">testImplementation &apos;org.robolectric:robolectric:4.5.1&apos;</span><br><span class="line">testImplementation &apos;androidx.test:core:1.3.0&apos;</span><br><span class="line">testImplementation &apos;androidx.test.ext:junit:1.1.2&apos;</span><br><span class="line">testImplementation &apos;androidx.test.espresso:espresso-core:3.3.0&apos;</span><br><span class="line">testImplementation &apos;androidx.test.espresso:espresso-intents:3.3.0&apos;</span><br><span class="line">debugImplementation &quot;androidx.fragment:fragment-testing:1.3.0&quot;</span><br></pre></td></tr></table></figure></p>
<p>编写测试用例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(AndroidJUnit4.class)</span><br><span class="line">@LargeTest</span><br><span class="line">public class UserCenterFragmentTest &#123;</span><br><span class="line">    @Test</span><br><span class="line">    public void show_show_user_center_ui_when_click_tab_dynamic() &#123;</span><br><span class="line">        //given</span><br><span class="line">        FragmentScenario&lt;UserCenterFragment&gt; scenario = FragmentScenario.launchInContainer(UserCenterFragment.class);</span><br><span class="line">        scenario.onFragment(activity -&gt; &#123;</span><br><span class="line">            //then</span><br><span class="line">            onView(withText(&quot;Hello user center fragment&quot;)).check(matches(isDisplayed()));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>执行测试命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew userBundle:testDebug</span><br></pre></td></tr></table></figure></p>
<p>运行结果如下：</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBa90da1e952cae1f1f8a41a55936666c6?method=download&amp;shareKey=88839dde7bd30caf97515f567a1ef4a6" alt=""></p>
<p>完整代码示例见<a href="https://github.com/junbin1011/CloudDisk/commit/e8439d74c113e6ef73ee12bd8c9893a853525e2a" target="_blank" rel="noopener">Github</a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>经过了解耦、分库及编译调试的优化，一段时间内，CloudDisk的开发效率得到了很大的提升。</p>
<p>但随着业务的演进，由于历史的原因，代码中存在很多Activity及Controller的上帝类。团队发现独立的业务Bundle质量还是比较差，Bug也比较多。团队决定再次对模块类的代码进行优化重构，采用新的MVP、MVVM架构将数据及视图分离。</p>
<p>下一篇，移动应用遗留系统重构（13）- MVP重构示例篇，一镜到底，我们将通过视频及文章的方式进行演示。</p>
<h1 id="CloudDisk示例代码"><a href="#CloudDisk示例代码" class="headerlink" title="CloudDisk示例代码"></a>CloudDisk示例代码</h1><p><a href="https://github.com/junbin1011/CloudDisk" target="_blank" rel="noopener">CloudDisk</a></p>
<h1 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h1><p><a href="https://juejin.cn/post/6943470229905211422" target="_blank" rel="noopener">移动应用遗留系统重构（1）- 开篇</a></p>
<p><a href="https://juejin.cn/post/6945313969556946980" target="_blank" rel="noopener">移动应用遗留系统重构（2）-架构篇</a></p>
<p><a href="https://juejin.cn/post/6947855094272491556" target="_blank" rel="noopener">移动应用遗留系统重构（3）-示例篇</a></p>
<p><a href="https://juejin.cn/post/6950077521790500894" target="_blank" rel="noopener">移动应用遗留系统重构（4）-分析篇</a></p>
<p><a href="https://juejin.cn/post/6952298178095874055" target="_blank" rel="noopener">移动应用遗留系统重构（5）- 重构方法篇</a></p>
<p><a href="https://juejin.cn/post/6954635678982340622" target="_blank" rel="noopener">移动应用遗留系统重构（6）- 测试篇</a></p>
<p><a href="https://juejin.cn/post/6959504791642832909" target="_blank" rel="noopener">移动应用遗留系统重构（7）- 解耦重构演示篇(一)+视频演示</a></p>
<p><a href="https://juejin.cn/post/6963214120178941983" target="_blank" rel="noopener">移动应用遗留系统重构（8）- 依赖注入篇</a></p>
<p><a href="https://juejin.cn/post/6966166367821103117" target="_blank" rel="noopener">移动应用遗留系统重构（9）- 路由篇</a></p>
<p><a href="https://juejin.cn/post/6970870458660945934" target="_blank" rel="noopener">移动应用遗留系统重构（10）- 解耦重构演示篇（二）</a></p>
<p><a href="https://juejin.cn/post/6973836199655899149" target="_blank" rel="noopener">移动应用遗留系统重构（11）- 制品管理篇</a></p>
<h1 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h1><p><img src="https://note.youdao.com/yws/api/personal/file/WEBf483992c4f5299577eeb0c039992c8d6?method=download&amp;shareKey=fd4babce2b0d344869bb1b2f7042417d" alt=""></p>
<h1 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h1><ul>
<li>作者：黄俊彬 </li>
<li><a href="https://junbin.tech/" target="_blank" rel="noopener">博客：junbin.tech</a></li>
<li><a href="https://github.com/junbin1011" target="_blank" rel="noopener">GitHub: junbin1011 </a></li>
<li><a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" rel="noopener">知乎: @JunBin</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2021/06/15/移动应用遗留系统重构（11）-制品管理篇/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/06/15/移动应用遗留系统重构（11）-制品管理篇/" itemprop="url">
                  移动应用遗留系统重构（11）- 制品管理篇
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-15T09:58:47+08:00">
                2021-06-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/06/15/移动应用遗留系统重构（11）-制品管理篇/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/06/15/移动应用遗留系统重构（11）-制品管理篇/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇我们提到CloudDisk团队决定将团队划分为5个团队，分别管理文件、动态、用户中心、平台及公共库。整个项目不再统一使用一个Git大仓进行代码管理，每个团队能独立维护自己的代码仓库。</p>
<p>但目前虽然各个模块已经解耦完成，但还是以源码的依赖的形式进行编译。我们要将业务拆分独立的仓库，需要把源码的依赖都调整为二进制的依赖才行。本篇我们就对CloudDisk进行改造，解开源码的编译依赖。</p>
<h1 id="二进制发布配置"><a href="#二进制发布配置" class="headerlink" title="二进制发布配置"></a>二进制发布配置</h1><p>这里我们选择常用的maven进行管理。为了方便演示，我们使用本地maven进行配置。实际项目中我们只要把地址设置为服务器的maven地址则可，在模块的build.gradle添加代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &apos;maven&apos;</span><br><span class="line"></span><br><span class="line">group = &apos;com.cloud.disk&apos;</span><br><span class="line">archivesBaseName = &apos;library&apos;</span><br><span class="line">version = &apos;1.0.0&apos;</span><br><span class="line"></span><br><span class="line">repositories.mavenCentral()</span><br><span class="line"></span><br><span class="line">uploadArchives &#123;</span><br><span class="line">    repositories.mavenDeployer &#123;</span><br><span class="line">        repository(url: &apos;file:&apos;+ rootDir.getPath()+&apos;/lib&apos;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在根目录的build.gradle添加代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven&#123;</span><br><span class="line">            url &apos;file:&apos;+ rootDir.getPath()+&apos;/lib&apos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>工程中就可以引用本地maven发布的jar包了。</p>
<p>触发版本发布,执行如下命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew :library:uploadArchives</span><br></pre></td></tr></table></figure>
<h1 id="CloudDisk重构示例"><a href="#CloudDisk重构示例" class="headerlink" title="CloudDisk重构示例"></a>CloudDisk重构示例</h1><p>具体Library改造示例代码见<a href="https://github.com/junbin1011/CloudDisk/commit/0d3a6a51bee60c479a43e013259ff2e08b1d04cb" target="_blank" rel="noopener">Github</a></p>
<p>这里我们看看改造后的App Gradle文件dependency如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">implementation &apos;com.cloud.disk:library:1.0.0&apos;</span><br><span class="line">implementation &apos;com.cloud.disk:api:1.0.0&apos;</span><br><span class="line">implementation &apos;com.cloud.disk:platform:1.0.0&apos;</span><br><span class="line"></span><br><span class="line">implementation &apos;com.cloud.disk.bundle:file:1.0.0&apos;</span><br><span class="line">implementation &apos;com.cloud.disk.bundle:dynamic:1.0.0&apos;</span><br><span class="line">implementation &apos;com.cloud.disk.bundle:user:1.0.0&apos;</span><br></pre></td></tr></table></figure></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>基于前面我们做了大量的解耦工作，本篇我们通过本地maven进行二进制管理，实际项目中这些aar都在远程的maven中管理。我们也可以将各个业务特性在独立的仓库中管理。</p>
<p>在架构设计中App是整体工程的集成，用于集成及最后的发布。分仓后所有的业务Bundle在独立的仓库中维护，我们希望Bundle能够进行独立的编译调试，下一篇移动应用遗留系统重构（12）- 编译调试篇，我们将继续对CloudDisk进行改造，让业务Bundle支持独立的编译调试。</p>
<h1 id="CloudDisk示例代码"><a href="#CloudDisk示例代码" class="headerlink" title="CloudDisk示例代码"></a>CloudDisk示例代码</h1><p><a href="https://github.com/junbin1011/CloudDisk" target="_blank" rel="noopener">CloudDisk</a></p>
<h1 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h1><p><a href="https://juejin.cn/post/6943470229905211422" target="_blank" rel="noopener">移动应用遗留系统重构（1）- 开篇</a></p>
<p><a href="https://juejin.cn/post/6945313969556946980" target="_blank" rel="noopener">移动应用遗留系统重构（2）-架构篇</a></p>
<p><a href="https://juejin.cn/post/6947855094272491556" target="_blank" rel="noopener">移动应用遗留系统重构（3）-示例篇</a></p>
<p><a href="https://juejin.cn/post/6950077521790500894" target="_blank" rel="noopener">移动应用遗留系统重构（4）-分析篇</a></p>
<p><a href="https://juejin.cn/post/6952298178095874055" target="_blank" rel="noopener">移动应用遗留系统重构（5）- 重构方法篇</a></p>
<p><a href="https://juejin.cn/post/6954635678982340622" target="_blank" rel="noopener">移动应用遗留系统重构（6）- 测试篇</a></p>
<p><a href="https://juejin.cn/post/6959504791642832909" target="_blank" rel="noopener">移动应用遗留系统重构（7）- 解耦重构演示篇(一)+视频演示</a></p>
<p><a href="https://juejin.cn/post/6963214120178941983" target="_blank" rel="noopener">移动应用遗留系统重构（8）- 依赖注入篇</a></p>
<p><a href="https://juejin.cn/post/6966166367821103117" target="_blank" rel="noopener">移动应用遗留系统重构（9）- 路由篇</a></p>
<p><a href="https://juejin.cn/post/6970870458660945934" target="_blank" rel="noopener">移动应用遗留系统重构（10）- 解耦重构演示篇（二）</a></p>
<h1 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h1><p><img src="https://note.youdao.com/yws/api/personal/file/WEBf483992c4f5299577eeb0c039992c8d6?method=download&amp;shareKey=fd4babce2b0d344869bb1b2f7042417d" alt=""></p>
<h1 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h1><ul>
<li>作者：黄俊彬 </li>
<li><a href="https://junbin.tech/" target="_blank" rel="noopener">博客：junbin.tech</a></li>
<li><a href="https://github.com/junbin1011" target="_blank" rel="noopener">GitHub: junbin1011 </a></li>
<li><a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" rel="noopener">知乎: @JunBin</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2021/06/07/移动应用遗留系统重构（10）-解耦重构演示篇（二）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/06/07/移动应用遗留系统重构（10）-解耦重构演示篇（二）/" itemprop="url">
                  移动应用遗留系统重构（10）- 解耦重构演示篇（二）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-07T10:09:38+08:00">
                2021-06-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/06/07/移动应用遗留系统重构（10）-解耦重构演示篇（二）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/06/07/移动应用遗留系统重构（10）-解耦重构演示篇（二）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在<a href="https://juejin.cn/post/6963214120178941983" target="_blank" rel="noopener">移动应用遗留系统重构（8）- 依赖注入篇
</a>、<a href="https://juejin.cn/post/6966166367821103117" target="_blank" rel="noopener">移动应用遗留系统重构（9）- 路由篇</a>章节中，我们已经完成了基础的注入和路由框架搭建。接着<a href="https://juejin.cn/post/6959504791642832909" target="_blank" rel="noopener">移动应用遗留系统重构（7）- 解耦重构演示篇(一)+视频演示
</a>,本篇我们会把App中剩余的 platform 包、dynamic 包进行重构。文中会主要列出分析及解耦的思路及过程,并且会有详细的完整演示视频。</p>
<p><strong>platform包重构代码演示：</strong><br><a href="https://mp.weixin.qq.com/s/YJLBFBD9T6F0zW7hWINoZA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/YJLBFBD9T6F0zW7hWINoZA</a></p>
<p><strong>dynamic 包重构代码演示：</strong><br><a href="https://mp.weixin.qq.com/s/ZcDDIrJwUbz5JCgrzjfteg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ZcDDIrJwUbz5JCgrzjfteg</a></p>
<h1 id="安全重构演示"><a href="#安全重构演示" class="headerlink" title="安全重构演示"></a>安全重构演示</h1><h2 id="platform-包重构"><a href="#platform-包重构" class="headerlink" title="platform 包重构"></a>platform 包重构</h2><ol>
<li>依赖分析</li>
</ol>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB20315a1c7461f5d6380f78c80437cb41?method=download&amp;shareKey=9f1d6c906815b5da19486d59973f36f2" alt=""></p>
<p>platform 中存在对上层bundle中的反向依赖，该依赖需要解除后，便可将该包下沉到platform的模块中。</p>
<ol start="2">
<li>安全重构</li>
</ol>
<p>重构前代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> public class LoginActivity extends AppCompatActivity &#123;</span><br><span class="line"></span><br><span class="line">    UserController userController = new UserController();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_login);</span><br><span class="line">        userController.login(&quot;&quot;, &quot;&quot;, new CallBack() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void success(String message) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void filed(String message) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重构手法：<strong>提取代理类、内联、移动</strong></p>
<ul>
<li>由于UserControler中存在login及getUserInfo方法，我们不能简单将类一起下沉，需要抽取独立类将login方法和LoginActivity一起内聚下沉</li>
</ul>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB1fc4d93cb70aaca6d30404ed75410df9?method=download&amp;shareKey=2da6020618d2aa890e986e35aaeac13a" alt=""></p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBdb54a5fa8f02d579973b4fab6a276be3?method=download&amp;shareKey=73ba5452e0e6dbe93572efe950ed4dd8" alt=""></p>
<p>重构后代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class UserController &#123;</span><br><span class="line">    public static boolean isLogin = false;</span><br><span class="line">    public final LoginController loginController = new LoginController();</span><br><span class="line"></span><br><span class="line">    public boolean login(String id, String password, CallBack callBack) &#123;</span><br><span class="line">        //用户登录</span><br><span class="line">        return loginController.login(id, password, callBack);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public UserInfo getUserInfo() &#123;</span><br><span class="line">        //获取用户信息</span><br><span class="line">        return loginController.getUserInfo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>将LoginActivity对UserController的调用内联为对LoginController的调用</li>
</ul>
<p>内联login方法：<br><img src="https://note.youdao.com/yws/api/personal/file/WEB14d05f484fc749eea26036e37a9bc3f1?method=download&amp;shareKey=f76b810c0b921711dcfeb5c871f62f14" alt=""></p>
<p>内联loginController：<br><img src="https://note.youdao.com/yws/api/personal/file/WEB3a89a9dbf9508e7633e8bed85407cbeb?method=download&amp;shareKey=1b6b4df87beb989e019da0b9c5b5b134" alt=""></p>
<p>抽取成员变量：</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBbd785820b2fe08b4841580eeb75b1577?method=download&amp;shareKey=a58dc6494a68a6e7a60f2280f54b0dc9" alt=""></p>
<p>重构后代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public class LoginActivity extends AppCompatActivity &#123;</span><br><span class="line"></span><br><span class="line">    private LoginController loginController = new LoginController();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_login);</span><br><span class="line">        //用户登录</span><br><span class="line">        loginController.login(&quot;&quot;, &quot;&quot;, new CallBack() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void success(String message) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void filed(String message) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol start="3">
<li>代码移动</li>
</ol>
<p>代码移动至独立的platform，加上对应的Gradle依赖：</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBe6ed4d585e0976fdef47480c7b8e40d0?method=download&amp;shareKey=8532a1692a88ff1e04d4fcfe7d544567" alt=""></p>
<ol start="4">
<li>功能验证<br>执行冒烟测试，验证功能</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./gradlew app:testDeb</span><br><span class="line">ug --tests SmokeTesting</span><br></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBbaff5f043f366f8ce6c213cabba8b661?method=download&amp;shareKey=15c44bc893cac332e00e02e598375771" alt=""><br><strong>代码演示： <a href="https://mp.weixin.qq.com/s/YJLBFBD9T6F0zW7hWINoZA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/YJLBFBD9T6F0zW7hWINoZA</a></strong></p>
<p>具体的代码：<a href="https://github.com/junbin1011/CloudDisk/commit/0adcc7d7b8fac54ede058420b5be56fc9e0629dc" target="_blank" rel="noopener">github链接</a></p>
<h2 id="dynamic-包重构"><a href="#dynamic-包重构" class="headerlink" title="dynamic 包重构"></a>dynamic 包重构</h2><ol>
<li>依赖分析</li>
</ol>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBa209e00bd30a6bf03e390086c0963dc9?method=download&amp;shareKey=436f6d8516546d1dbf13f90be8b752fd" alt=""></p>
<p>dynamic包存在对fileBundle和userBundle之间的横向依赖。主要是因为动态中需要上传和下载文件，所以依赖了fileBundle，另外需要判断是否登录，所以也依赖了userBundle</p>
<ol start="2">
<li>安全重构</li>
</ol>
<p>重构前代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">public class DynamicFragment extends Fragment &#123;</span><br><span class="line"></span><br><span class="line">    DynamicController dynamicController = new DynamicController();</span><br><span class="line">    FileController fileController = new FileController(new UserStateImpl());</span><br><span class="line">    Button btnShare;</span><br><span class="line">    public static DynamicFragment newInstance() &#123;</span><br><span class="line">        DynamicFragment fragment = new DynamicFragment();</span><br><span class="line">        Bundle args = new Bundle();</span><br><span class="line">        fragment.setArguments(args);</span><br><span class="line">        return fragment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        dynamicController.getDynamicList();</span><br><span class="line">        FileInfo fileInfo = fileController.upload(&quot;/data/data/user.png&quot;);</span><br><span class="line">        dynamicController.post(new Dynamic(), fileInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class DynamicController &#123;</span><br><span class="line"></span><br><span class="line">    FileController fileController=new FileController(new UserStateImpl());</span><br><span class="line"></span><br><span class="line">    public boolean post(Dynamic dynamic, FileInfo fileInfo) &#123;</span><br><span class="line">        //发送一条动态消息</span><br><span class="line">        if (!UserController.isLogin) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        HttpUtils.post(&quot;http://dynamic&quot;, LoginController.userId);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;Dynamic&gt; getDynamicList() &#123;</span><br><span class="line">        //通过网络获取动态信息,有些动态带有附件需要下载</span><br><span class="line">        fileController.download(&quot;&quot;);</span><br><span class="line">        return new ArrayList&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>重构手法：<strong>提前代理类、抽取接口、移动、内联、提取变量等</strong></p>
<p>由于FileController中除了上传和下载还有获取文件的方案，我们不能简单粗暴就把整个FileController提前接口，希望抽取除了的接口职责更加单一。</p>
<ul>
<li>抽取FileTransfer类，提取接口</li>
<li>将对FileController的依赖内联为FileTransfer</li>
<li>对UserBundle的依赖使用已经抽取的UserState接口</li>
<li>使用注入的方式进行依赖管理</li>
</ul>
<blockquote>
<p>由于步骤比较多，大家可以直接看视频的演示，这里就不一一截图说明。</p>
</blockquote>
<p>重构后代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">@AndroidEntryPoint</span><br><span class="line">public class DynamicFragment extends Fragment &#123;</span><br><span class="line"></span><br><span class="line">    @Inject</span><br><span class="line">    DynamicController dynamicController;</span><br><span class="line">    Button btnShare;</span><br><span class="line">    @Inject</span><br><span class="line">    TransferFile transferFile;</span><br><span class="line"></span><br><span class="line">    public static DynamicFragment newInstance() &#123;</span><br><span class="line">        DynamicFragment fragment = new DynamicFragment();</span><br><span class="line">        Bundle args = new Bundle();</span><br><span class="line">        fragment.setArguments(args);</span><br><span class="line">        return fragment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        dynamicController.getDynamicList();</span><br><span class="line">        //上传文件</span><br><span class="line">        FileInfo fileInfo = transferFile.upload(&quot;/data/data/user.png&quot;);</span><br><span class="line">        dynamicController.post(new Dynamic(), fileInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class DynamicController &#123;</span><br><span class="line"></span><br><span class="line">    @Inject</span><br><span class="line">    TransferFile transferFile;</span><br><span class="line">    @Inject</span><br><span class="line">    UserState userState;</span><br><span class="line"></span><br><span class="line">    @Inject</span><br><span class="line">    public DynamicController() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean post(Dynamic dynamic, FileInfo fileInfo) &#123;</span><br><span class="line">        //发送一条动态消息</span><br><span class="line">        if (!userState.isLogin()) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        HttpUtils.post(&quot;http://dynamic&quot;, LoginController.userId);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;Dynamic&gt; getDynamicList() &#123;</span><br><span class="line">        //通过网络获取动态信息,有些动态带有附件需要下载</span><br><span class="line">        //下载文件</span><br><span class="line">        transferFile.download(&quot;&quot;);</span><br><span class="line">        return new ArrayList&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol start="3">
<li>代码移动</li>
</ol>
<p>代码移动至独立的dynamic Bundle，加上对应的Gradle依赖：</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB6eb57e6392a74c38536c69e94ce2a7f6?method=download&amp;shareKey=f15e163af24acd151e4fd612e9168f94" alt=""></p>
<ol start="4">
<li>功能验证<br>执行冒烟测试，验证功能</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./gradlew app:testDeb</span><br><span class="line">ug --tests SmokeTesting</span><br></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBbaff5f043f366f8ce6c213cabba8b661?method=download&amp;shareKey=15c44bc893cac332e00e02e598375771" alt=""></p>
<p><strong>代码演示：<a href="https://mp.weixin.qq.com/s/ZcDDIrJwUbz5JCgrzjfteg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ZcDDIrJwUbz5JCgrzjfteg</a></strong></p>
<p>具体的代码：<a href="https://github.com/junbin1011/CloudDisk/commit/a1067bfca48e2f2e5a59e1bda94a2c56e7b55f5c" target="_blank" rel="noopener">github链接</a></p>
<h1 id="ArchUnit"><a href="#ArchUnit" class="headerlink" title="ArchUnit"></a>ArchUnit</h1><p>在重构的过程中，我们补充了api的模块，我们需要调整ArchUnit的用例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(ArchUnitRunner.class)</span><br><span class="line">@AnalyzeClasses(packages = &quot;com.cloud.disk&quot;)</span><br><span class="line">public class ArchRuleTest &#123;</span><br><span class="line"></span><br><span class="line">    @ArchTest</span><br><span class="line">    public static final ArchRule architecture_layer_should_has_right_dependency =layeredArchitecture()</span><br><span class="line">            .layer(&quot;Library&quot;).definedBy(&quot;..cloud.disk.library..&quot;)</span><br><span class="line">            .layer(&quot;Api&quot;).definedBy(&quot;..cloud.disk.api..&quot;)</span><br><span class="line">            .layer(&quot;PlatForm&quot;).definedBy(&quot;..cloud.disk.platform..&quot;)</span><br><span class="line">            .layer(&quot;FileBundle&quot;).definedBy(&quot;..cloud.disk.bundle.file..&quot;)</span><br><span class="line">            .layer(&quot;DynamicBundle&quot;).definedBy(&quot;..cloud.disk.bundle.dynamic..&quot;)</span><br><span class="line">            .layer(&quot;UserBundle&quot;).definedBy(&quot;..cloud.disk.bundle.user..&quot;)</span><br><span class="line">            .layer(&quot;AllBundle&quot;).definedBy(&quot;..cloud.disk.bundle..&quot;)</span><br><span class="line">            .layer(&quot;App&quot;).definedBy(&quot;..cloud.disk.app..&quot;)</span><br><span class="line">            .whereLayer(&quot;App&quot;).mayOnlyBeAccessedByLayers()</span><br><span class="line">            .whereLayer(&quot;FileBundle&quot;).mayOnlyBeAccessedByLayers(&quot;App&quot;)</span><br><span class="line">            .whereLayer(&quot;DynamicBundle&quot;).mayOnlyBeAccessedByLayers(&quot;App&quot;)</span><br><span class="line">            .whereLayer(&quot;UserBundle&quot;).mayOnlyBeAccessedByLayers(&quot;App&quot;)</span><br><span class="line">            .whereLayer(&quot;PlatForm&quot;).mayOnlyBeAccessedByLayers(&quot;App&quot;,&quot;AllBundle&quot;)</span><br><span class="line">            .whereLayer(&quot;Api&quot;).mayOnlyBeAccessedByLayers(&quot;App&quot;,&quot;AllBundle&quot;,&quot;PlatForm&quot;)</span><br><span class="line">            .whereLayer(&quot;Library&quot;).mayOnlyBeAccessedByLayers(&quot;App&quot;,&quot;AllBundle&quot;,&quot;PlatForm&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目前所有之前的架构设计约束已经完整解耦开，但由于测试文件和Hilt会生成一些编译的问题，所以我们还得新增配置文件进行过滤。</p>
<p>在resource文件夹中新增文件archunit_ignore_patterns.txt，新增过滤规则如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.*com.cloud.disk.SmokeTesting.*</span><br><span class="line">.*com.cloud.disk.DaggerSmokeTesting_*.*</span><br></pre></td></tr></table></figure></p>
<p>运行架构守护测试命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew app:testDebug --tests ArchRuleTest</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到已正常运行通过。</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBd57e058ace18b246cf22d3ceb2eadabd?method=download&amp;shareKey=b0695709714c7c693fd01a3ae0d66179" alt=""></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>经过不断的<strong>演进重构</strong>，目前我们终于把设计的架构守护测试通过，我们通过一张图来对比一下前面的区别。</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB9e99a1df9b882c8486f637a4d4e56dee?method=download&amp;shareKey=a8dd390088541d8e40e02f8583fc0b72" alt=""></p>
<p>随着第一阶段的解耦重构完成，CloudDisk团队决定将团队划分为5个团队，分别管理文件、动态、用户中心、平台及公共库。整个项目不再统一使用一个Git大仓进行代码管理，每个团队能独立维护自己的代码仓库。</p>
<p>下一篇，移动应用遗留系统重构（11）- 制品管理篇将分享如何将解耦的模块进行二进制发布，模块间不再使用源码依赖编译，能按设计在独立的git仓库中进行管理。</p>
<h1 id="CloudDisk示例代码"><a href="#CloudDisk示例代码" class="headerlink" title="CloudDisk示例代码"></a>CloudDisk示例代码</h1><p><a href="https://github.com/junbin1011/CloudDisk" target="_blank" rel="noopener">CloudDisk</a></p>
<h1 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h1><p><a href="https://juejin.cn/post/6943470229905211422" target="_blank" rel="noopener">移动应用遗留系统重构（1）- 开篇</a></p>
<p><a href="https://juejin.cn/post/6945313969556946980" target="_blank" rel="noopener">移动应用遗留系统重构（2）-架构篇</a></p>
<p><a href="https://juejin.cn/post/6947855094272491556" target="_blank" rel="noopener">移动应用遗留系统重构（3）-示例篇</a></p>
<p><a href="https://juejin.cn/post/6950077521790500894" target="_blank" rel="noopener">移动应用遗留系统重构（4）-分析篇</a></p>
<p><a href="https://juejin.cn/post/6952298178095874055" target="_blank" rel="noopener">移动应用遗留系统重构（5）- 重构方法篇</a></p>
<p><a href="https://juejin.cn/post/6954635678982340622" target="_blank" rel="noopener">移动应用遗留系统重构（6）- 测试篇</a></p>
<p><a href="https://juejin.cn/post/6959504791642832909" target="_blank" rel="noopener">移动应用遗留系统重构（7）- 解耦重构演示篇(一)+视频演示</a></p>
<p><a href="https://juejin.cn/post/6963214120178941983" target="_blank" rel="noopener">移动应用遗留系统重构（8）- 依赖注入篇</a></p>
<p><a href="https://juejin.cn/post/6966166367821103117" target="_blank" rel="noopener">移动应用遗留系统重构（9）- 路由篇</a></p>
<h1 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h1><p><img src="https://note.youdao.com/yws/api/personal/file/WEBf483992c4f5299577eeb0c039992c8d6?method=download&amp;shareKey=fd4babce2b0d344869bb1b2f7042417d" alt=""></p>
<h1 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h1><p><strong>欢迎关注CAC敏捷教练公众号</strong>。微信搜索：<strong>CAC敏捷教练</strong>。</p>
<ul>
<li>作者：黄俊彬 </li>
<li><a href="https://junbin.tech/" target="_blank" rel="noopener">博客：junbin.tech</a></li>
<li><a href="https://github.com/junbin1011" target="_blank" rel="noopener">GitHub: junbin1011 </a></li>
<li><a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" rel="noopener">知乎: @JunBin</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://junbin1011.github.io/2021/05/25/移动应用遗留系统重构（9）-路由篇/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄俊彬">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JunBin">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/05/25/移动应用遗留系统重构（9）-路由篇/" itemprop="url">
                  移动应用遗留系统重构（9）- 路由篇
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-25T21:09:17+08:00">
                2021-05-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/05/25/移动应用遗留系统重构（9）-路由篇/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/05/25/移动应用遗留系统重构（9）-路由篇/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇<a href="https://juejin.cn/post/6963214120178941983" target="_blank" rel="noopener">移动应用遗留系统重构（8）- 依赖注入篇
</a>最后我们通过IDE的依赖分析发现，App模块主界面直接依赖了file Bundle的FileFragment，存在直接的编译依赖。 </p>
<p>跨模块对Activity或Fragment的依赖是应用内最常见的。但是如果有直接代码上的依赖，我们就无法做到业务模块独立编译调试，后续做动态化也没办法统一管理。本篇我们主要分为3个部分，第一部分是路由的原理，第二部分是业内优秀的路由框架实践，最后我们将继续对CloudDisk中UI跳转进行重构。</p>
<h1 id="路由原理"><a href="#路由原理" class="headerlink" title="路由原理"></a>路由原理</h1><p>Android中常用的页面跳转就是通过直接的依赖方式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = new Intent(MainActivity.this, LoginActivity.class);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>
<p>但其实Intent还有另外一个API支持使用类名进行隐式跳转。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = new Intent();</span><br><span class="line">intent.setClassName(this,&quot;com.cloud.disk.platform.login.LoginActivity&quot;);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>
<p>这种方式就不会存在编译的问题。但当整个应用内的页面跳转量很大时，我们就很难全局进行统一维护。并且很多场景需要动态推送页面跳转，我们需要统一管理所有页面的地址，这个时候我们就需要有统一的方案进行路由管理。</p>
<p>那么如何进行统一的管理呢？其实一个很自然的思路就是建立一个统一的映射，例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uri://user/login -&gt; com.cloud.disk.platform.login.LoginActivity</span><br></pre></td></tr></table></figure></p>
<p>然后通过一个统一的方式进行管理，这就是所谓的路由表。当应用进行跳转时，输入虚拟的地址，经过路由表进行查询得到实际的地址，然后就可进行跳转。并且有了这一层转换，我们就可以做很多扩展，例如降级、拦截等等</p>
<p>下面就让我们一起来看看一些业内的优秀实践。</p>
<h1 id="业内优秀实践"><a href="#业内优秀实践" class="headerlink" title="业内优秀实践"></a>业内优秀实践</h1><h2 id="ARouter"><a href="#ARouter" class="headerlink" title="ARouter"></a><a href="https://github.com/alibaba/ARouter" target="_blank" rel="noopener">ARouter</a></h2><p>ARouter主要采用的也是路由表的方式，具体的使用和原理，网上有很多资料。这里主要列出官网上介绍的一些主要的功能。</p>
<ul>
<li>支持直接解析标准URL进行跳转，并自动注入参数到目标页面中</li>
<li>支持多模块工程使用</li>
<li>支持添加多个拦截器，自定义拦截顺序</li>
<li>支持依赖注入，可单独作为依赖注入框架使用</li>
<li>映射关系按组分类、多级管理，按需初始化<br>支持用户指定全局降级与局部降级策略<br>页面、拦截器、服务等组件均自动注册到框架<br>支持多种方式配置转场动画</li>
<li>支持获取Fragment</li>
<li>完全支持Kotlin以及混编</li>
<li>支持第三方 App 加固(使用 arouter-register 实现自动注册)</li>
<li>支持生成路由文档</li>
<li>提供 IDE 插件便捷的关联路径和目标类</li>
</ul>
<p>更多详细的介绍和使用说明，可以参考<a href="https://github.com/alibaba/ARouter/blob/master/README_CN.md" target="_blank" rel="noopener">Github上的介绍</a></p>
<blockquote>
<p>这里我们从Github上的介绍发现，同样采用了注解和Gradle插件在编译时生成文件，但ARouter并没有像Hilt那样有完善的测试套件支持，所以如果使用Robolectric在JVM上进行测试会有影响。</p>
</blockquote>
<h2 id="DeepLinkDispatch"><a href="#DeepLinkDispatch" class="headerlink" title="DeepLinkDispatch"></a><a href="https://github.com/airbnb/DeepLinkDispatch/" target="_blank" rel="noopener">DeepLinkDispatch</a></h2><p>DeepLinkDispatch是airbnb开源的一个路由框架，原理也是采用路由表的方式。</p>
<p>提供声明性的、基于注释的API来定义应用程序深度链接。<br>可以注册一个Activity来处理特定的深度链接，方法是使用@DeepLink和URI对其进行注释。DeepLinkDispatch将解析URI并将深度链接与URI中指定的任何参数一起发送到适当的Activity。</p>
<p>相比之下，功能没有ARouter强大，且国内的社区活跃度没有ARouter高，具体的使用方式可以参考<a href="https://github.com/airbnb/DeepLinkDispatch" target="_blank" rel="noopener">官方的介绍</a></p>
<h1 id="CloudDisk路由重构示例"><a href="#CloudDisk路由重构示例" class="headerlink" title="CloudDisk路由重构示例"></a>CloudDisk路由重构示例</h1><p>经过对比，我们决定使用功能相对强大且社区活跃度高的ARouter，对CloudDisk进行改造。具体的完整代码示例<a href="https://github.com/junbin1011/CloudDisk/commit/ab0bbc0785faf41817683e0b509e9c1b122ce7db" target="_blank" rel="noopener">Github</a>。这里我们贴出前后代码使用的比较。</p>
<p>改造前：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fragments.add(FileFragment.newInstance());</span><br></pre></td></tr></table></figure></p>
<p>改造后：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//声明</span><br><span class="line">@Route(path = &quot;/bundle/file&quot;)</span><br><span class="line">public class FileFragment extends Fragment </span><br><span class="line"></span><br><span class="line">//调用</span><br><span class="line">fragments.add((Fragment) ARouter.getInstance().build(&quot;/bundle/file&quot;).navigation()）;</span><br></pre></td></tr></table></figure></p>
<p>但当我们运行冒烟测试的时候发现出现空异常，如下</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB1b1b29a47f7f137cca1fc06976373f9d?method=download&amp;shareKey=6cc14ab80015ab5eebff8a0f6cab39be" alt=""></p>
<p>ARouter的navigation并不能找到实例，上面我们有提到ARouter同样采用了注解和Gradle插件在编译时生成文件，但ARouter并没有像Hilt那样有完善的测试套件支持，在JVM上进行测试会有影响。这里我们采用的方案是Shadow，将实际ARouter的跳转Mock掉。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Implements(Postcard.class)</span><br><span class="line">public class ShadowPostCard &#123;</span><br><span class="line"></span><br><span class="line">    @RealObject</span><br><span class="line">    public Postcard postcard;</span><br><span class="line"></span><br><span class="line">    @Implementation</span><br><span class="line">    public Object navigation() &#123;</span><br><span class="line">        if (&quot;/bundle/file&quot;.equals(postcard.getPath())) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                return Class.forName(&quot;com.cloud.disk.bundle.file.FileFragment&quot;).newInstance();</span><br><span class="line">            &#125; catch (ClassNotFoundException | IllegalAccessException | InstantiationException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEBd3b7b5287020064ea859cf6f2de97dff?method=download&amp;shareKey=c3f320eaf380ab13fe6ff4b51bacaa2c" alt=""></p>
<blockquote>
<p>我们还可以考虑把测试用例放入androidTest，使用真机运行测试。但为了得到更快的反馈速度，我们决定先沿用shadow的方案。</p>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>使用路由除了能解耦开编译时的依赖，统一了路由地址也能更好的满足应用的跳转场景。目前CloudDisk已经解耦了lib和file bundle 2个模块，并且基础的注入和路由也已经有了，下一篇单体移动应用“模块化”演进之旅（10）- 解耦重构演示篇（二）我们将继续分享对platform、user、dynamic进行依赖解除重构，将会分享更多的实战解耦手法。</p>
<h1 id="CloudDisk示例代码"><a href="#CloudDisk示例代码" class="headerlink" title="CloudDisk示例代码"></a>CloudDisk示例代码</h1><p><a href="https://github.com/junbin1011/CloudDisk" target="_blank" rel="noopener">CloudDisk</a></p>
<h1 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h1><p><a href="https://juejin.cn/post/6943470229905211422" target="_blank" rel="noopener">移动应用遗留系统重构（1）- 开篇</a></p>
<p><a href="https://juejin.cn/post/6945313969556946980" target="_blank" rel="noopener">移动应用遗留系统重构（2）-架构篇</a></p>
<p><a href="https://juejin.cn/post/6947855094272491556" target="_blank" rel="noopener">移动应用遗留系统重构（3）-示例篇</a></p>
<p><a href="https://juejin.cn/post/6950077521790500894" target="_blank" rel="noopener">移动应用遗留系统重构（4）-分析篇</a></p>
<p><a href="https://juejin.cn/post/6952298178095874055" target="_blank" rel="noopener">移动应用遗留系统重构（5）- 重构方法篇</a></p>
<p><a href="https://juejin.cn/post/6954635678982340622" target="_blank" rel="noopener">移动应用遗留系统重构（6）- 测试篇</a></p>
<p><a href="https://juejin.cn/post/6959504791642832909" target="_blank" rel="noopener">移动应用遗留系统重构（7）- 解耦重构演示篇(一)+视频演示</a></p>
<p><a href="https://juejin.cn/post/6963214120178941983" target="_blank" rel="noopener">移动应用遗留系统重构（8）- 依赖注入篇</a></p>
<h1 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h1><p><img src="https://note.youdao.com/yws/api/personal/file/WEBf483992c4f5299577eeb0c039992c8d6?method=download&amp;shareKey=fd4babce2b0d344869bb1b2f7042417d" alt=""></p>
<h1 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h1><p><strong>欢迎关注CAC敏捷教练公众号</strong>。微信搜索：<strong>CAC敏捷教练</strong>。</p>
<ul>
<li>作者：黄俊彬 </li>
<li><a href="https://junbin.tech/" target="_blank" rel="noopener">博客：junbin.tech</a></li>
<li><a href="https://github.com/junbin1011" target="_blank" rel="noopener">GitHub: junbin1011 </a></li>
<li><a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" rel="noopener">知乎: @JunBin</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="https://note.youdao.com/yws/api/personal/file/WEB917b08143504a6f8c96228312fcb5245?method=download&shareKey=03cb5c302c83b56bbb91668c5008444f" alt="黄俊彬">
          <p class="site-author-name" itemprop="name">黄俊彬</p>
           
              <p class="site-description motion-element" itemprop="description">一花一世界，一码一浮生</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">100</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/junbin1011" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" title="zhihu">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  zhihu
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">黄俊彬</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"junbin"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


  

</body>
</html>
